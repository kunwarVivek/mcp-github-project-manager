---
phase: 11-ai-issue-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/services/ai/IssueEnrichmentAIService.ts
  - src/services/ai/LabelSuggestionService.ts
  - src/services/ai/prompts/IssueIntelligencePrompts.ts
autonomous: true

must_haves:
  truths:
    - "Issue enrichment generates structured sections with per-section confidence scores"
    - "Enrichment preserves original description when substantial (>200 chars)"
    - "Label suggestions are grouped by confidence tier (high/medium/low)"
    - "Label suggestions include rationale explaining why each label was suggested"
    - "Services fall back to keyword matching when AI unavailable"
  artifacts:
    - path: "src/services/ai/IssueEnrichmentAIService.ts"
      provides: "AI-powered issue enrichment with structured sections"
      exports: ["IssueEnrichmentAIService"]
    - path: "src/services/ai/LabelSuggestionService.ts"
      provides: "Multi-tier label suggestions with learning from history"
      exports: ["LabelSuggestionService"]
    - path: "src/services/ai/prompts/IssueIntelligencePrompts.ts"
      provides: "Prompt templates for issue intelligence AI calls"
      exports: ["ENRICHMENT_SYSTEM_PROMPT", "LABEL_SUGGESTION_SYSTEM_PROMPT"]
  key_links:
    - from: "src/services/ai/IssueEnrichmentAIService.ts"
      to: "src/services/ai/AIServiceFactory.ts"
      via: "AIServiceFactory.getInstance()"
      pattern: "AIServiceFactory\\.getInstance"
    - from: "src/services/ai/LabelSuggestionService.ts"
      to: "src/domain/issue-intelligence-types.ts"
      via: "LabelSuggestionResult import"
      pattern: "import.*from.*issue-intelligence-types"
---

<objective>
Create AI services for issue enrichment (AI-17) and label suggestions (AI-18).

Purpose: Implement the core AI functionality for improving issue quality and suggesting labels. These services follow the BacklogPrioritizer pattern with AI + fallback.

Output:
- `src/services/ai/IssueEnrichmentAIService.ts` - Structured enrichment with confidence scoring
- `src/services/ai/LabelSuggestionService.ts` - Multi-tier label suggestions with history learning
- `src/services/ai/prompts/IssueIntelligencePrompts.ts` - Prompt templates for both services
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ai-issue-intelligence/11-CONTEXT.md
@.planning/phases/11-ai-issue-intelligence/11-RESEARCH.md
@.planning/phases/11-ai-issue-intelligence/11-01-SUMMARY.md
@src/services/ai/BacklogPrioritizer.ts (AI service pattern with fallback)
@src/services/ai/ConfidenceScorer.ts (confidence calculation pattern)
@src/services/ai/prompts/SprintPlanningPrompts.ts (prompt template pattern)
@src/domain/issue-intelligence-types.ts (types from 11-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IssueIntelligencePrompts.ts</name>
  <files>src/services/ai/prompts/IssueIntelligencePrompts.ts</files>
  <action>
Create prompt templates for issue enrichment and label suggestion AI calls. Follow the SprintPlanningPrompts.ts pattern.

**File header:**
```typescript
/**
 * Prompt Templates for Issue Intelligence AI Services
 *
 * System prompts and formatters for:
 * - Issue enrichment (AI-17)
 * - Label suggestions (AI-18)
 * - Duplicate detection (AI-19)
 * - Related issue linking (AI-20)
 */
```

**ENRICHMENT_SYSTEM_PROMPT:**
- Role: Issue analysis expert who improves issue quality
- Guidelines:
  - Generate structured sections: Problem (what's wrong), Solution (proposed fix), Context (relevant background), Impact (who/what is affected), Acceptance Criteria (how to verify complete)
  - Provide per-section confidence (0-1) based on information completeness
  - If original description is substantial (>200 chars), preserve it and add AI sections below
  - If original is short, integrate into comprehensive rewrite
  - Suggest relevant labels based on content analysis
  - Identify potential assignees if domain expertise is apparent
- Output format: JSON matching EnrichedIssue structure

**formatEnrichmentPrompt function:**
- Takes: issueTitle, issueDescription, projectContext?, preserveOriginal boolean
- Returns: Formatted prompt with issue details

**LABEL_SUGGESTION_SYSTEM_PROMPT:**
- Role: Repository label expert
- Guidelines:
  - Prefer existing repository labels over proposing new ones
  - Group suggestions by confidence tier (high: 0.8+, medium: 0.5-0.8, low: <0.5)
  - Provide rationale for each suggestion
  - If issue history provided, learn from past labeling patterns
  - Only propose new labels when no existing label fits AND the pattern is common
- Output format: JSON matching LabelSuggestionResult structure

**formatLabelPrompt function:**
- Takes: issueTitle, issueDescription, existingLabels array, issueHistory? array
- Returns: Formatted prompt with labels and optional history context

**DUPLICATE_DETECTION_SYSTEM_PROMPT** (for Plan 03):
- Role: Issue similarity analyst
- Guidelines for identifying duplicates vs related issues

**RELATED_ISSUE_SYSTEM_PROMPT** (for Plan 03):
- Role: Issue relationship analyst
- Guidelines for detecting semantic, dependency, and component relationships

Export all prompts and formatters.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/services/ai/prompts/IssueIntelligencePrompts.ts`</verify>
  <done>4 system prompts and 4 formatter functions for issue intelligence AI</done>
</task>

<task type="auto">
  <name>Task 2: Create IssueEnrichmentAIService.ts</name>
  <files>src/services/ai/IssueEnrichmentAIService.ts</files>
  <action>
Create AI service for issue enrichment. Follow the BacklogPrioritizer.ts pattern.

**File header:**
```typescript
/**
 * AI-Powered Issue Enrichment Service (AI-17)
 *
 * Enriches issues with structured sections, per-section confidence scores,
 * and suggested labels/assignees. Supports preserve-vs-rewrite logic based
 * on original description length.
 */

import { generateObject } from 'ai';
import { z } from 'zod';
import { AIServiceFactory } from './AIServiceFactory.js';
import { ConfidenceScorer } from './ConfidenceScorer.js';
import { ENRICHMENT_SYSTEM_PROMPT, formatEnrichmentPrompt } from './prompts/IssueIntelligencePrompts.js';
import { EnrichedIssue, EnrichedSection, EnrichedIssueSections } from '../../domain/issue-intelligence-types.js';
import { SectionConfidence, ConfidenceFactors, ConfidenceTier } from '../../domain/ai-types.js';
```

**Class: IssueEnrichmentAIService**

Constructor:
- Initialize AIServiceFactory.getInstance()
- Initialize ConfidenceScorer

**Method: async enrichIssue(params)**
Params: { issueTitle, issueDescription, projectContext?, repositoryLabels? }
Returns: Promise<EnrichedIssue>

Implementation:
1. Determine preserveOriginal: (issueDescription?.length || 0) > 200
2. Get AI model from factory (getModel('main') || getBestAvailableModel())
3. If no model, call getFallbackEnrichment()
4. Otherwise, call generateObject with:
   - model
   - system: ENRICHMENT_SYSTEM_PROMPT
   - prompt: formatEnrichmentPrompt(params, preserveOriginal)
   - schema: Zod schema for enrichment response
   - temperature: 0.4 (for consistent enrichment)
5. Calculate per-section confidence using ConfidenceScorer
6. Format and return EnrichedIssue

**Method: private getFallbackEnrichment(params): EnrichedIssue**
- Create basic structure with original content
- Set all confidence scores to low (40)
- Add "AI unavailable, using basic structure" reasoning
- Mark needsReview: true

**Method: private calculateSectionConfidence(section, inputData): SectionConfidence**
- Use ConfidenceScorer.calculateConfidence() pattern
- inputCompleteness based on section content length
- aiSelfAssessment from AI response if available
- patternMatch based on section structure quality

Export class.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/services/ai/IssueEnrichmentAIService.ts`</verify>
  <done>IssueEnrichmentAIService with enrichIssue method, fallback behavior, and confidence scoring</done>
</task>

<task type="auto">
  <name>Task 3: Create LabelSuggestionService.ts</name>
  <files>src/services/ai/LabelSuggestionService.ts</files>
  <action>
Create AI service for label suggestions. Follow the BacklogPrioritizer.ts pattern.

**File header:**
```typescript
/**
 * AI-Powered Label Suggestion Service (AI-18)
 *
 * Suggests labels for issues with tiered confidence (high/medium/low),
 * rationale for each suggestion, and learning from issue history.
 * Prefers existing repository labels over proposing new ones.
 */

import { generateObject } from 'ai';
import { z } from 'zod';
import { AIServiceFactory } from './AIServiceFactory.js';
import { ConfidenceScorer } from './ConfidenceScorer.js';
import { LABEL_SUGGESTION_SYSTEM_PROMPT, formatLabelPrompt } from './prompts/IssueIntelligencePrompts.js';
import { LabelSuggestion, LabelSuggestionResult, NewLabelProposal, LabelSuggestionConfig } from '../../domain/issue-intelligence-types.js';
import { SectionConfidence } from '../../domain/ai-types.js';
```

**Default config:**
```typescript
const DEFAULT_CONFIG: LabelSuggestionConfig = {
  preferExisting: true,
  maxSuggestions: 10,
  includeNewProposals: true,
  confidenceThresholds: { high: 0.8, medium: 0.5 }
};
```

**Class: LabelSuggestionService**

Constructor:
- config?: Partial<LabelSuggestionConfig>
- Initialize AIServiceFactory.getInstance()
- Initialize ConfidenceScorer
- Merge config with defaults

**Method: async suggestLabels(params)**
Params: { issueTitle, issueDescription, existingLabels: Array<{name, description?, color?}>, issueHistory?: Array<{labels, title}> }
Returns: Promise<LabelSuggestionResult>

Implementation:
1. Get AI model from factory
2. If no model, call getFallbackSuggestions()
3. Otherwise, call generateObject with:
   - model
   - system: LABEL_SUGGESTION_SYSTEM_PROMPT
   - prompt: formatLabelPrompt(params)
   - schema: Zod schema for label suggestions
   - temperature: 0.3 (for consistent labeling)
4. Sort suggestions into tiers based on config thresholds
5. Apply maxSuggestions limit
6. Filter out newLabelProposals if config.includeNewProposals is false
7. Calculate overall confidence
8. Return LabelSuggestionResult

**Method: private getFallbackSuggestions(params): LabelSuggestionResult**
- Use keywordMatchLabels() to find matches
- Low confidence (40) with "AI unavailable" reasoning
- No new label proposals in fallback mode

**Method: private keywordMatchLabels(params, minScore: number): LabelSuggestion[]**
- Extract keywords from title and description
- Match against existingLabels names and descriptions
- Calculate simple relevance score based on keyword overlap
- Return matches above minScore

**Method: private calculateMatchScore(keywords: string[], label: {name, description?}): number**
- Check if label name contains any keywords
- Check if label description contains any keywords
- Return normalized score 0-1

Export class.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/services/ai/LabelSuggestionService.ts`</verify>
  <done>LabelSuggestionService with suggestLabels method, tiered output, history learning, and fallback</done>
</task>

</tasks>

<verification>
Run after all tasks complete:
```bash
# TypeScript compilation
npx tsc --noEmit

# Verify service structure
grep "class IssueEnrichmentAIService" src/services/ai/IssueEnrichmentAIService.ts
grep "class LabelSuggestionService" src/services/ai/LabelSuggestionService.ts

# Verify AIServiceFactory usage
grep "AIServiceFactory.getInstance" src/services/ai/IssueEnrichmentAIService.ts
grep "AIServiceFactory.getInstance" src/services/ai/LabelSuggestionService.ts

# Verify fallback methods
grep "getFallbackEnrichment" src/services/ai/IssueEnrichmentAIService.ts
grep "getFallbackSuggestions" src/services/ai/LabelSuggestionService.ts
```
</verification>

<success_criteria>
- [ ] TypeScript compilation passes with 0 errors
- [ ] IssueEnrichmentAIService has enrichIssue method with AI + fallback
- [ ] LabelSuggestionService has suggestLabels method with tiered output
- [ ] Both services use AIServiceFactory for model access
- [ ] Both services have fallback behavior when AI unavailable
- [ ] Prompt templates exported from IssueIntelligencePrompts.ts
</success_criteria>

<output>
After completion, create `.planning/phases/11-ai-issue-intelligence/11-02-SUMMARY.md`
</output>
