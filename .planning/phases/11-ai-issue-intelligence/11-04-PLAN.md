---
phase: 11-ai-issue-intelligence
plan: 04
type: execute
wave: 3
depends_on: ["11-02", "11-03"]
files_modified:
  - src/infrastructure/tools/issue-intelligence-tools.ts
  - tests/services/ai/IssueEnrichmentAIService.test.ts
  - tests/services/ai/LabelSuggestionService.test.ts
  - tests/services/ai/DuplicateDetectionService.test.ts
  - tests/services/ai/RelatedIssueLinkingService.test.ts
  - tests/infrastructure/tools/issue-intelligence-tools.test.ts
  - tests/cache/EmbeddingCache.test.ts
  - docs/TOOLS.md
  - STATUS.md
autonomous: true

must_haves:
  truths:
    - "4 MCP tools are registered and callable: enrich_issue, suggest_labels, detect_duplicates, find_related_issues"
    - "Each tool has input validation, annotations, and structured output"
    - "AI services have comprehensive unit tests including fallback paths"
    - "EmbeddingCache has unit tests for TTL and eviction"
    - "Documentation updated with new tools"
  artifacts:
    - path: "src/infrastructure/tools/issue-intelligence-tools.ts"
      provides: "4 MCP tools for issue intelligence"
      exports: ["enrichIssueTool", "suggestLabelsTool", "detectDuplicatesTool", "findRelatedIssuesTool"]
    - path: "tests/services/ai/IssueEnrichmentAIService.test.ts"
      provides: "Unit tests for enrichment service"
      min_lines: 100
    - path: "tests/services/ai/LabelSuggestionService.test.ts"
      provides: "Unit tests for label suggestion service"
      min_lines: 100
    - path: "tests/services/ai/DuplicateDetectionService.test.ts"
      provides: "Unit tests for duplicate detection service"
      min_lines: 100
    - path: "tests/services/ai/RelatedIssueLinkingService.test.ts"
      provides: "Unit tests for related issue linking service"
      min_lines: 100
    - path: "tests/cache/EmbeddingCache.test.ts"
      provides: "Unit tests for embedding cache"
      min_lines: 50
    - path: "docs/TOOLS.md"
      provides: "Updated tool documentation"
      contains: "enrich_issue"
  key_links:
    - from: "src/infrastructure/tools/issue-intelligence-tools.ts"
      to: "src/services/ai/IssueEnrichmentAIService.ts"
      via: "service instantiation in executor"
      pattern: "new IssueEnrichmentAIService"
---

<objective>
Create MCP tools, comprehensive tests, and documentation for Phase 11 AI Issue Intelligence.

Purpose: Expose AI services as MCP tools with proper schemas, run comprehensive tests, and update documentation.

Output:
- `src/infrastructure/tools/issue-intelligence-tools.ts` - 4 MCP tools with executors
- 6 test files with ~200+ tests total covering all services and tools
- Updated `docs/TOOLS.md` with 4 new tools
- Updated `STATUS.md` with Phase 11 status
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ai-issue-intelligence/11-CONTEXT.md
@.planning/phases/11-ai-issue-intelligence/11-01-SUMMARY.md
@.planning/phases/11-ai-issue-intelligence/11-02-SUMMARY.md
@.planning/phases/11-ai-issue-intelligence/11-03-SUMMARY.md
@src/infrastructure/tools/sprint-ai-tools.ts (MCP tool pattern)
@tests/services/ai/BacklogPrioritizer.test.ts (AI service test pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create issue-intelligence-tools.ts MCP tools</name>
  <files>src/infrastructure/tools/issue-intelligence-tools.ts</files>
  <action>
Create 4 MCP tools for issue intelligence. Follow the sprint-ai-tools.ts pattern.

**File header:**
```typescript
/**
 * MCP tools for AI-powered issue intelligence operations.
 *
 * Provides 4 tools (AI-17 to AI-20):
 * - enrich_issue: Enhance issue with structured sections and confidence (AI-17)
 * - suggest_labels: Multi-tier label suggestions with rationale (AI-18)
 * - detect_duplicates: Embedding-based duplicate detection (AI-19)
 * - find_related_issues: Multi-type relationship detection (AI-20)
 *
 * These tools expose Phase 11 AI Issue Intelligence services as MCP tools
 * with proper annotations, input/output schemas, and executors.
 */

import { ToolDefinition, ToolSchema } from "./ToolValidator.js";
import { ANNOTATION_PATTERNS } from "./annotations/tool-annotations.js";
import { IssueEnrichmentAIService } from "../../services/ai/IssueEnrichmentAIService.js";
import { LabelSuggestionService } from "../../services/ai/LabelSuggestionService.js";
import { DuplicateDetectionService } from "../../services/ai/DuplicateDetectionService.js";
import { RelatedIssueLinkingService } from "../../services/ai/RelatedIssueLinkingService.js";
import {
  EnrichIssueInputSchema,
  EnrichIssueInput,
  EnrichIssueOutputSchema,
  EnrichIssueOutput,
  SuggestLabelsInputSchema,
  SuggestLabelsInput,
  SuggestLabelsOutputSchema,
  SuggestLabelsOutput,
  DetectDuplicatesInputSchema,
  DetectDuplicatesInput,
  DetectDuplicatesOutputSchema,
  DetectDuplicatesOutput,
  FindRelatedIssuesInputSchema,
  FindRelatedIssuesInput,
  FindRelatedIssuesOutputSchema,
  FindRelatedIssuesOutput,
} from "./schemas/issue-intelligence-schemas.js";
```

**Tool Definitions:**

1. **enrich_issue (AI-17)**
   - name: "enrich_issue"
   - title: "Enrich Issue"
   - description: "Enhance issue with structured sections (Problem/Solution/Context/Impact/AcceptanceCriteria), per-section confidence scores, and suggested labels. Preserves original content when substantial."
   - annotations: ANNOTATION_PATTERNS.aiOperation
   - schema: EnrichIssueInputSchema
   - outputSchema: EnrichIssueOutputSchema

2. **suggest_labels (AI-18)**
   - name: "suggest_labels"
   - title: "Suggest Labels"
   - description: "Suggest labels for an issue with tiered confidence (high/medium/low), rationale for each suggestion, and optional new label proposals. Prefers existing repository labels."
   - annotations: ANNOTATION_PATTERNS.aiOperation
   - schema: SuggestLabelsInputSchema
   - outputSchema: SuggestLabelsOutputSchema

3. **detect_duplicates (AI-19)**
   - name: "detect_duplicates"
   - title: "Detect Duplicate Issues"
   - description: "Detect potential duplicate issues using semantic similarity (embeddings). Results tiered: high confidence (0.92+) for auto-link, medium (0.75-0.92) for review, low for reference."
   - annotations: ANNOTATION_PATTERNS.aiOperation
   - schema: DetectDuplicatesInputSchema
   - outputSchema: DetectDuplicatesOutputSchema

4. **find_related_issues (AI-20)**
   - name: "find_related_issues"
   - title: "Find Related Issues"
   - description: "Find related issues by semantic similarity, dependency chains (blocks/blocked-by), and component grouping (shared labels). Returns relationships with confidence and reasoning."
   - annotations: ANNOTATION_PATTERNS.aiOperation
   - schema: FindRelatedIssuesInputSchema
   - outputSchema: FindRelatedIssuesOutputSchema

**Executors:**
- executeEnrichIssue: Instantiate IssueEnrichmentAIService, call enrichIssue, return result
- executeSuggestLabels: Instantiate LabelSuggestionService, call suggestLabels, return result
- executeDetectDuplicates: Instantiate DuplicateDetectionService, call detectDuplicates, return result
- executeFindRelatedIssues: Instantiate RelatedIssueLinkingService, call findRelatedIssues, return result

Export all tools and executors.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/infrastructure/tools/issue-intelligence-tools.ts`</verify>
  <done>4 MCP tools with definitions and executors following sprint-ai-tools pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for AI services</name>
  <files>
    tests/services/ai/IssueEnrichmentAIService.test.ts
    tests/services/ai/LabelSuggestionService.test.ts
    tests/services/ai/DuplicateDetectionService.test.ts
    tests/services/ai/RelatedIssueLinkingService.test.ts
    tests/cache/EmbeddingCache.test.ts
  </files>
  <action>
Create comprehensive unit tests for all Phase 11 AI services. Follow the BacklogPrioritizer.test.ts pattern.

**IssueEnrichmentAIService.test.ts (~50 tests):**
- Mock AIServiceFactory and 'ai' package generateObject
- Test describe blocks:
  1. "AI Path" - when model is available
     - Returns enriched issue with all sections
     - Calculates per-section confidence
     - Preserves original when description > 200 chars
     - Rewrites when description is short
     - Includes suggested labels
  2. "Fallback Path" - when model unavailable
     - Returns basic structure
     - Sets low confidence (40)
     - Sets needsReview: true
  3. "Edge Cases"
     - Empty description
     - Very long description
     - Missing project context

**LabelSuggestionService.test.ts (~50 tests):**
- Mock AIServiceFactory and 'ai' package generateObject
- Test describe blocks:
  1. "AI Path"
     - Returns tiered suggestions (high/medium/low)
     - Includes rationale for each suggestion
     - Prefers existing labels
     - Proposes new labels when configured
     - Uses issue history for learning
  2. "Fallback Path"
     - Uses keyword matching
     - No new label proposals
     - Low confidence
  3. "Configuration"
     - maxSuggestions limit
     - includeNewProposals toggle
     - Custom confidence thresholds

**DuplicateDetectionService.test.ts (~50 tests):**
- Mock 'ai' package embed, embedMany, cosineSimilarity
- Test describe blocks:
  1. "Embedding Path"
     - Tiers results correctly (high/medium/low)
     - Uses cache for existing issues
     - Returns newEmbedding for caching
  2. "Fallback Path"
     - Uses keyword overlap
     - Adjusted thresholds
  3. "Thresholds"
     - Default thresholds (0.92, 0.75)
     - Custom thresholds
  4. "Caching"
     - Cache hit for unchanged content
     - Cache miss for changed content

**RelatedIssueLinkingService.test.ts (~50 tests):**
- Mock 'ai' package and AIServiceFactory
- Test describe blocks:
  1. "Semantic Relations"
     - Finds similar issues via embeddings
  2. "Dependency Detection"
     - Detects 'blocks' keywords
     - Detects 'blocked_by' keywords
     - AI-enhanced dependency detection
  3. "Component Grouping"
     - Groups by shared labels
     - Calculates label overlap score
  4. "Configuration"
     - Toggle each relationship type

**EmbeddingCache.test.ts (~30 tests):**
- Test describe blocks:
  1. "Basic Operations"
     - get/set/has/clear/size
  2. "TTL Expiration"
     - Returns null for expired entries
     - Deletes expired entries
  3. "Content Hash Validation"
     - Returns null if hash changes
     - Computes hash correctly
  4. "Eviction"
     - Evicts oldest when exceeding maxSize

Use jest.mock() for external dependencies. Use jest.resetAllMocks() in beforeEach.
  </action>
  <verify>Tests pass: `npm test -- tests/services/ai/IssueEnrichmentAIService.test.ts tests/services/ai/LabelSuggestionService.test.ts tests/services/ai/DuplicateDetectionService.test.ts tests/services/ai/RelatedIssueLinkingService.test.ts tests/cache/EmbeddingCache.test.ts`</verify>
  <done>~230 unit tests covering all AI services and cache with AI and fallback paths</done>
</task>

<task type="auto">
  <name>Task 3: Create MCP tool tests and update documentation</name>
  <files>
    tests/infrastructure/tools/issue-intelligence-tools.test.ts
    docs/TOOLS.md
    STATUS.md
  </files>
  <action>
Create tool tests and update documentation.

**issue-intelligence-tools.test.ts (~60 tests):**
Follow the sprint-ai-tools.test.ts pattern with 3 describe blocks per tool.

For each tool (enrich_issue, suggest_labels, detect_duplicates, find_related_issues):
1. "Input Schemas" - validate schema constraints
2. "Tool Definitions" - verify name, title, annotations
3. "Executors" - test execution with mocked services

Mock the AI services (IssueEnrichmentAIService, etc.) to return test data.

**docs/TOOLS.md updates:**
Add new section: "## Issue Intelligence Tools (AI)"

Document each tool:
1. **enrich_issue** (AI-17)
   - Description
   - Input parameters
   - Output structure
   - Example usage

2. **suggest_labels** (AI-18)
   - Description
   - Input parameters (including optional history)
   - Output tiers (high/medium/low)
   - Example usage

3. **detect_duplicates** (AI-19)
   - Description
   - Input parameters
   - Confidence tiers explanation
   - Example usage

4. **find_related_issues** (AI-20)
   - Description
   - Relationship types
   - Configuration options
   - Example usage

Update tool count: 115 + 4 = 119 total tools

**STATUS.md updates:**
- Update "MCP Tools" count to 119
- Add Phase 11 to completed phases
- Update requirements completed count
  </action>
  <verify>
Tests pass: `npm test -- tests/infrastructure/tools/issue-intelligence-tools.test.ts`
Docs contain new tools: `grep -c "enrich_issue\|suggest_labels\|detect_duplicates\|find_related_issues" docs/TOOLS.md`
  </verify>
  <done>Tool tests passing, TOOLS.md updated with 4 new tools, STATUS.md updated</done>
</task>

</tasks>

<verification>
Run after all tasks complete:
```bash
# Full test suite
npm test

# Count new tests
npm test -- --testPathPattern="issue-intelligence|EmbeddingCache" --listTests | wc -l

# Verify tool registration (if tool registry has list capability)
grep -c "enrich_issue\|suggest_labels\|detect_duplicates\|find_related_issues" src/infrastructure/tools/issue-intelligence-tools.ts

# Verify documentation
grep "119 total" docs/TOOLS.md || grep "119 tools" docs/TOOLS.md || true
grep "enrich_issue" docs/TOOLS.md
grep "suggest_labels" docs/TOOLS.md
grep "detect_duplicates" docs/TOOLS.md
grep "find_related_issues" docs/TOOLS.md
```
</verification>

<success_criteria>
- [ ] All tests pass (npm test reports 0 failures)
- [ ] 4 MCP tools defined and exported from issue-intelligence-tools.ts
- [ ] ~200+ new tests across 6 test files
- [ ] docs/TOOLS.md documents all 4 new tools with examples
- [ ] STATUS.md updated with Phase 11 completion status
- [ ] Tool count updated to 119
</success_criteria>

<output>
After completion, create `.planning/phases/11-ai-issue-intelligence/11-04-SUMMARY.md`
</output>
