---
phase: 02-mcp-protocol-compliance
plan: 05
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - src/infrastructure/tools/ToolSchemas.ts
  - src/infrastructure/tools/schemas/issue-schemas.ts
  - src/infrastructure/tools/schemas/pr-schemas.ts
autonomous: true

must_haves:
  truths:
    - "All issue tools have behavior annotations"
    - "All PR tools have behavior annotations"
    - "All issue tools have output schemas defined"
    - "All PR tools have output schemas defined"
  artifacts:
    - path: "src/infrastructure/tools/schemas/issue-schemas.ts"
      provides: "Output schema definitions for issue tools"
      exports: ["IssueOutputSchema", "IssueListOutputSchema"]
    - path: "src/infrastructure/tools/schemas/pr-schemas.ts"
      provides: "Output schema definitions for PR tools"
      exports: ["PullRequestOutputSchema", "PullRequestListOutputSchema"]
  key_links:
    - from: "src/infrastructure/tools/ToolSchemas.ts"
      to: "src/infrastructure/tools/schemas/issue-schemas.ts"
      via: "import"
      pattern: "IssueOutputSchema"
---

<objective>
Add annotations and output schemas to all issue and pull request tools.

Purpose: Enable clients to understand issue/PR tool behavior and expected output types.
Output: 18+ issue and PR tools with annotations and type-safe output schemas.
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mcp-protocol-compliance/02-RESEARCH.md
@.planning/phases/02-mcp-protocol-compliance/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create issue output schema definitions</name>
  <files>src/infrastructure/tools/schemas/issue-schemas.ts</files>
  <action>
Create src/infrastructure/tools/schemas/issue-schemas.ts:

```typescript
import { z } from "zod";

// ===== Base Types =====

export const IssueUserSchema = z.object({
  id: z.string(),
  login: z.string(),
  avatarUrl: z.string().optional(),
});

export const IssueLabelSchema = z.object({
  id: z.string(),
  name: z.string(),
  color: z.string(),
  description: z.string().optional(),
});

// ===== Issue Output Schemas =====

export const IssueOutputSchema = z.object({
  id: z.string(),
  number: z.number(),
  title: z.string(),
  body: z.string().optional(),
  state: z.enum(["open", "closed"]),
  stateReason: z.enum(["completed", "not_planned", "reopened"]).optional(),
  author: IssueUserSchema.optional(),
  assignees: z.array(IssueUserSchema).optional(),
  labels: z.array(IssueLabelSchema).optional(),
  milestone: z.object({
    id: z.string(),
    title: z.string(),
  }).optional(),
  createdAt: z.string(),
  updatedAt: z.string(),
  closedAt: z.string().optional(),
  url: z.string(),
});

export const IssueListOutputSchema = z.object({
  issues: z.array(IssueOutputSchema),
  totalCount: z.number(),
  hasMore: z.boolean().optional(),
});

// ===== Issue Comment Schemas =====

export const IssueCommentOutputSchema = z.object({
  id: z.string(),
  body: z.string(),
  author: IssueUserSchema.optional(),
  createdAt: z.string(),
  updatedAt: z.string(),
  url: z.string(),
});

export const IssueCommentListOutputSchema = z.object({
  comments: z.array(IssueCommentOutputSchema),
  totalCount: z.number(),
  hasMore: z.boolean().optional(),
});

// ===== Draft Issue Schemas =====

export const DraftIssueOutputSchema = z.object({
  id: z.string(),
  title: z.string(),
  body: z.string().optional(),
  projectId: z.string(),
  createdAt: z.string(),
  updatedAt: z.string(),
});

// ===== Success/Delete Schemas (reuse from project-schemas if possible) =====

export const IssueDeleteOutputSchema = z.object({
  deleted: z.boolean(),
  id: z.string(),
  type: z.literal("issue_comment").or(z.literal("draft_issue")),
});
```
  </action>
  <verify>
```bash
npm run build
```
Build passes with new schemas.
  </verify>
  <done>Issue output schemas defined for all issue-related tools</done>
</task>

<task type="auto">
  <name>Task 2: Create PR output schema definitions</name>
  <files>src/infrastructure/tools/schemas/pr-schemas.ts</files>
  <action>
Create src/infrastructure/tools/schemas/pr-schemas.ts:

```typescript
import { z } from "zod";
import { IssueUserSchema, IssueLabelSchema } from "./issue-schemas.js";

// ===== Pull Request Output Schemas =====

export const PullRequestOutputSchema = z.object({
  id: z.string(),
  number: z.number(),
  title: z.string(),
  body: z.string().optional(),
  state: z.enum(["open", "closed", "merged"]),
  isDraft: z.boolean().optional(),
  author: IssueUserSchema.optional(),
  assignees: z.array(IssueUserSchema).optional(),
  reviewers: z.array(IssueUserSchema).optional(),
  labels: z.array(IssueLabelSchema).optional(),
  head: z.object({
    ref: z.string(),
    sha: z.string(),
  }),
  base: z.object({
    ref: z.string(),
    sha: z.string(),
  }),
  mergeable: z.boolean().optional(),
  merged: z.boolean(),
  mergedAt: z.string().optional(),
  mergedBy: IssueUserSchema.optional(),
  createdAt: z.string(),
  updatedAt: z.string(),
  closedAt: z.string().optional(),
  url: z.string(),
});

export const PullRequestListOutputSchema = z.object({
  pullRequests: z.array(PullRequestOutputSchema),
  totalCount: z.number(),
  hasMore: z.boolean().optional(),
});

// ===== PR Review Schemas =====

export const PullRequestReviewOutputSchema = z.object({
  id: z.string(),
  author: IssueUserSchema.optional(),
  body: z.string().optional(),
  state: z.enum(["APPROVED", "CHANGES_REQUESTED", "COMMENTED", "DISMISSED", "PENDING"]),
  submittedAt: z.string().optional(),
  url: z.string(),
});

export const PullRequestReviewListOutputSchema = z.object({
  reviews: z.array(PullRequestReviewOutputSchema),
  totalCount: z.number(),
});

// ===== Merge Output Schema =====

export const PullRequestMergeOutputSchema = z.object({
  merged: z.boolean(),
  sha: z.string().optional(),
  message: z.string(),
});
```
  </action>
  <verify>
```bash
npm run build
```
Build passes with new schemas.
  </verify>
  <done>PR output schemas defined for all PR-related tools</done>
</task>

<task type="auto">
  <name>Task 3: Add annotations to issue and PR tool definitions</name>
  <files>src/infrastructure/tools/ToolSchemas.ts</files>
  <action>
Update issue and PR tool definitions in ToolSchemas.ts:

1. Add imports at top of file:
```typescript
import {
  IssueOutputSchema,
  IssueListOutputSchema,
  IssueCommentOutputSchema,
  IssueCommentListOutputSchema,
  DraftIssueOutputSchema,
  IssueDeleteOutputSchema,
} from "./schemas/issue-schemas.js";

import {
  PullRequestOutputSchema,
  PullRequestListOutputSchema,
  PullRequestReviewOutputSchema,
  PullRequestReviewListOutputSchema,
  PullRequestMergeOutputSchema,
} from "./schemas/pr-schemas.js";
```

2. Update issue tool definitions:

```typescript
// Issue tools
export const createIssueTool: ToolDefinition<CreateIssueArgs, z.infer<typeof IssueOutputSchema>> = {
  name: "create_issue",
  title: "Create Issue",
  description: "Create a new issue in the repository",
  schema: createIssueSchema,
  outputSchema: IssueOutputSchema,
  annotations: ANNOTATION_PATTERNS.create,
};

export const listIssuesTool: ToolDefinition<ListIssuesArgs, z.infer<typeof IssueListOutputSchema>> = {
  name: "list_issues",
  title: "List Issues",
  description: "List issues in the repository",
  schema: listIssuesSchema,
  outputSchema: IssueListOutputSchema,
  annotations: ANNOTATION_PATTERNS.readOnly,
};

export const getIssueTool: ToolDefinition<GetIssueArgs, z.infer<typeof IssueOutputSchema>> = {
  name: "get_issue",
  title: "Get Issue",
  description: "Get details of a specific issue",
  schema: getIssueSchema,
  outputSchema: IssueOutputSchema,
  annotations: ANNOTATION_PATTERNS.readOnly,
};

export const updateIssueTool: ToolDefinition<UpdateIssueArgs, z.infer<typeof IssueOutputSchema>> = {
  name: "update_issue",
  title: "Update Issue",
  description: "Update an existing issue",
  schema: updateIssueSchema,
  outputSchema: IssueOutputSchema,
  annotations: ANNOTATION_PATTERNS.updateIdempotent,
};
```

3. Update issue comment tools:
```typescript
export const createIssueCommentTool: ToolDefinition<CreateIssueCommentArgs, z.infer<typeof IssueCommentOutputSchema>> = {
  name: "create_issue_comment",
  annotations: ANNOTATION_PATTERNS.updateNonIdempotent,  // Adds new comment each time
  // ... rest
};

export const updateIssueCommentTool: ToolDefinition<UpdateIssueCommentArgs, z.infer<typeof IssueCommentOutputSchema>> = {
  name: "update_issue_comment",
  annotations: ANNOTATION_PATTERNS.updateIdempotent,
  // ...
};

export const deleteIssueCommentTool: ToolDefinition<DeleteIssueCommentArgs, z.infer<typeof IssueDeleteOutputSchema>> = {
  name: "delete_issue_comment",
  annotations: ANNOTATION_PATTERNS.delete,
  // ...
};

export const listIssueCommentsTool: ToolDefinition<ListIssueCommentsArgs, z.infer<typeof IssueCommentListOutputSchema>> = {
  name: "list_issue_comments",
  annotations: ANNOTATION_PATTERNS.readOnly,
  // ...
};
```

4. Update draft issue tools:
```typescript
export const createDraftIssueTool: ToolDefinition<CreateDraftIssueArgs, z.infer<typeof DraftIssueOutputSchema>> = {
  name: "create_draft_issue",
  annotations: ANNOTATION_PATTERNS.create,
  // ...
};

export const updateDraftIssueTool: ToolDefinition<UpdateDraftIssueArgs, z.infer<typeof DraftIssueOutputSchema>> = {
  name: "update_draft_issue",
  annotations: ANNOTATION_PATTERNS.updateIdempotent,
  // ...
};

export const deleteDraftIssueTool: ToolDefinition<DeleteDraftIssueArgs, z.infer<typeof IssueDeleteOutputSchema>> = {
  name: "delete_draft_issue",
  annotations: ANNOTATION_PATTERNS.delete,
  // ...
};
```

5. Update PR tools:
```typescript
export const createPullRequestTool: ToolDefinition<CreatePullRequestArgs, z.infer<typeof PullRequestOutputSchema>> = {
  name: "create_pull_request",
  annotations: ANNOTATION_PATTERNS.create,
  // ...
};

export const getPullRequestTool: ToolDefinition<GetPullRequestArgs, z.infer<typeof PullRequestOutputSchema>> = {
  name: "get_pull_request",
  annotations: ANNOTATION_PATTERNS.readOnly,
  // ...
};

export const listPullRequestsTool: ToolDefinition<ListPullRequestsArgs, z.infer<typeof PullRequestListOutputSchema>> = {
  name: "list_pull_requests",
  annotations: ANNOTATION_PATTERNS.readOnly,
  // ...
};

export const updatePullRequestTool: ToolDefinition<UpdatePullRequestArgs, z.infer<typeof PullRequestOutputSchema>> = {
  name: "update_pull_request",
  annotations: ANNOTATION_PATTERNS.updateIdempotent,
  // ...
};

export const mergePullRequestTool: ToolDefinition<MergePullRequestArgs, z.infer<typeof PullRequestMergeOutputSchema>> = {
  name: "merge_pull_request",
  annotations: {
    ...ANNOTATION_PATTERNS.updateIdempotent,
    destructiveHint: true,  // Merging is a significant action
  },
  // ...
};

export const listPullRequestReviewsTool: ToolDefinition<ListPullRequestReviewsArgs, z.infer<typeof PullRequestReviewListOutputSchema>> = {
  name: "list_pull_request_reviews",
  annotations: ANNOTATION_PATTERNS.readOnly,
  // ...
};

export const createPullRequestReviewTool: ToolDefinition<CreatePullRequestReviewArgs, z.infer<typeof PullRequestReviewOutputSchema>> = {
  name: "create_pull_request_review",
  annotations: ANNOTATION_PATTERNS.create,
  // ...
};
```
  </action>
  <verify>
```bash
npm run build
npm test
grep -c "annotations:" src/infrastructure/tools/ToolSchemas.ts
```
Build passes and annotation count increases.
  </verify>
  <done>All issue and PR tools have annotations and output schemas</done>
</task>

</tasks>

<verification>
1. All 11 issue tools have annotations (create, list, get, update, comment x4, draft x3)
2. All 7 PR tools have annotations (create, get, list, update, merge, reviews x2)
3. All tools have matching outputSchema
4. Build and tests pass
</verification>

<success_criteria>
- Every issue tool has behavior annotation
- Every PR tool has behavior annotation
- Output schemas match actual return types
- Comments marked as updateNonIdempotent (adds new each time)
- Merge marked as destructive
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-protocol-compliance/02-05-SUMMARY.md`
</output>
