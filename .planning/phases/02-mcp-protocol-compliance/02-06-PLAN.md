---
phase: 02-mcp-protocol-compliance
plan: 06
type: execute
wave: 5
depends_on: ["02-05"]
files_modified:
  - src/infrastructure/tools/ToolSchemas.ts
  - src/infrastructure/tools/schemas/ai-schemas.ts
  - src/infrastructure/tools/schemas/automation-schemas.ts
  - src/infrastructure/tools/ai-tasks/GeneratePRDTool.ts
  - src/infrastructure/tools/ai-tasks/ParsePRDTool.ts
  - src/infrastructure/tools/ai-tasks/ExpandTaskTool.ts
  - src/infrastructure/tools/ai-tasks/AnalyzeTaskComplexityTool.ts
  - src/infrastructure/tools/ai-tasks/AddFeatureTool.ts
  - src/infrastructure/tools/ai-tasks/EnhancePRDTool.ts
  - src/infrastructure/tools/ai-tasks/GetNextTaskTool.ts
  - src/infrastructure/tools/ai-tasks/CreateTraceabilityMatrixTool.ts
autonomous: true

must_haves:
  truths:
    - "All AI tools have aiOperation annotations"
    - "All automation tools have behavior annotations"
    - "All AI tools have output schemas defined"
    - "All automation tools have output schemas defined"
  artifacts:
    - path: "src/infrastructure/tools/schemas/ai-schemas.ts"
      provides: "Output schema definitions for AI tools"
      exports: ["PRDOutputSchema", "TaskOutputSchema"]
    - path: "src/infrastructure/tools/schemas/automation-schemas.ts"
      provides: "Output schema definitions for automation tools"
      exports: ["AutomationRuleOutputSchema"]
  key_links:
    - from: "src/infrastructure/tools/ToolSchemas.ts"
      to: "src/infrastructure/tools/schemas/ai-schemas.ts"
      via: "import"
      pattern: "PRDOutputSchema"
---

<objective>
Add annotations and output schemas to all AI and automation tools.

Purpose: Enable clients to understand AI/automation tool behavior and expected output types.
Output: 20+ AI and automation tools with annotations and type-safe output schemas.
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mcp-protocol-compliance/02-RESEARCH.md
@.planning/phases/02-mcp-protocol-compliance/02-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI tool output schema definitions</name>
  <files>src/infrastructure/tools/schemas/ai-schemas.ts</files>
  <action>
Create src/infrastructure/tools/schemas/ai-schemas.ts:

```typescript
import { z } from "zod";

// ===== PRD Schemas =====

export const PRDSectionSchema = z.object({
  title: z.string(),
  content: z.string(),
  subsections: z.array(z.object({
    title: z.string(),
    content: z.string(),
  })).optional(),
});

export const PRDOutputSchema = z.object({
  id: z.string().optional(),
  title: z.string(),
  summary: z.string(),
  sections: z.array(PRDSectionSchema),
  metadata: z.object({
    version: z.string().optional(),
    createdAt: z.string().optional(),
    updatedAt: z.string().optional(),
  }).optional(),
});

export const PRDParseOutputSchema = z.object({
  features: z.array(z.object({
    id: z.string(),
    title: z.string(),
    description: z.string(),
    priority: z.enum(["high", "medium", "low"]).optional(),
    complexity: z.enum(["simple", "medium", "complex"]).optional(),
  })),
  requirements: z.array(z.object({
    id: z.string(),
    description: z.string(),
    type: z.enum(["functional", "non-functional", "constraint"]).optional(),
  })).optional(),
});

export const PRDEnhanceOutputSchema = z.object({
  enhancedPRD: PRDOutputSchema,
  improvements: z.array(z.object({
    section: z.string(),
    change: z.string(),
    reason: z.string(),
  })),
});

// ===== Task Schemas =====

export const TaskOutputSchema = z.object({
  id: z.string(),
  title: z.string(),
  description: z.string(),
  priority: z.enum(["high", "medium", "low"]).optional(),
  complexity: z.enum(["simple", "medium", "complex"]).optional(),
  estimatedHours: z.number().optional(),
  dependencies: z.array(z.string()).optional(),
  subtasks: z.array(z.object({
    id: z.string(),
    title: z.string(),
    description: z.string(),
  })).optional(),
  assignee: z.string().optional(),
  labels: z.array(z.string()).optional(),
});

export const TaskListOutputSchema = z.object({
  tasks: z.array(TaskOutputSchema),
  totalCount: z.number(),
});

export const TaskComplexityOutputSchema = z.object({
  taskId: z.string(),
  complexity: z.enum(["simple", "medium", "complex"]),
  score: z.number(),
  factors: z.array(z.object({
    factor: z.string(),
    impact: z.enum(["low", "medium", "high"]),
    description: z.string(),
  })),
  recommendation: z.string().optional(),
});

export const TaskExpandOutputSchema = z.object({
  originalTaskId: z.string(),
  subtasks: z.array(TaskOutputSchema),
  totalSubtasks: z.number(),
});

export const NextTaskOutputSchema = z.object({
  task: TaskOutputSchema.optional(),
  reason: z.string(),
  alternatives: z.array(z.object({
    taskId: z.string(),
    reason: z.string(),
  })).optional(),
});

// ===== Feature Schemas =====

export const FeatureOutputSchema = z.object({
  id: z.string(),
  title: z.string(),
  description: z.string(),
  userStories: z.array(z.object({
    id: z.string(),
    story: z.string(),
    acceptanceCriteria: z.array(z.string()),
  })).optional(),
  tasks: z.array(TaskOutputSchema).optional(),
});

export const AddFeatureOutputSchema = z.object({
  feature: FeatureOutputSchema,
  issuesCreated: z.array(z.object({
    id: z.string(),
    number: z.number(),
    title: z.string(),
    url: z.string(),
  })).optional(),
});

// ===== Traceability Matrix Schema =====

export const TraceabilityMatrixOutputSchema = z.object({
  requirements: z.array(z.object({
    id: z.string(),
    description: z.string(),
    linkedFeatures: z.array(z.string()),
    linkedTasks: z.array(z.string()),
    coverage: z.enum(["full", "partial", "none"]),
  })),
  coverage: z.object({
    totalRequirements: z.number(),
    coveredRequirements: z.number(),
    coveragePercentage: z.number(),
  }),
});

// ===== Roadmap Generation Schema =====

export const GeneratedRoadmapOutputSchema = z.object({
  projectId: z.string().optional(),
  phases: z.array(z.object({
    name: z.string(),
    description: z.string(),
    milestones: z.array(z.object({
      title: z.string(),
      features: z.array(z.string()),
      estimatedDuration: z.string().optional(),
    })),
  })),
  timeline: z.object({
    startDate: z.string().optional(),
    endDate: z.string().optional(),
    totalDuration: z.string().optional(),
  }).optional(),
});

// ===== Issue Enrichment Schema =====

export const EnrichedIssueOutputSchema = z.object({
  issueId: z.string(),
  originalTitle: z.string(),
  enrichedTitle: z.string().optional(),
  enrichedDescription: z.string().optional(),
  suggestedLabels: z.array(z.string()).optional(),
  suggestedAssignees: z.array(z.string()).optional(),
  suggestedPriority: z.enum(["high", "medium", "low"]).optional(),
  suggestedComplexity: z.enum(["simple", "medium", "complex"]).optional(),
  relatedIssues: z.array(z.string()).optional(),
});

export const BulkEnrichOutputSchema = z.object({
  enrichedIssues: z.array(EnrichedIssueOutputSchema),
  totalProcessed: z.number(),
  successCount: z.number(),
  failureCount: z.number(),
});

// ===== Issue Triaging Schema =====

export const TriagedIssueOutputSchema = z.object({
  issueId: z.string(),
  category: z.string(),
  priority: z.enum(["high", "medium", "low"]),
  suggestedLabels: z.array(z.string()),
  suggestedMilestone: z.string().optional(),
  triageNotes: z.string().optional(),
});

export const TriageAllOutputSchema = z.object({
  triagedIssues: z.array(TriagedIssueOutputSchema),
  totalProcessed: z.number(),
  byCategory: z.record(z.string(), z.number()).optional(),
  byPriority: z.record(z.string(), z.number()).optional(),
});

export const ScheduleTriagingOutputSchema = z.object({
  scheduled: z.boolean(),
  scheduleId: z.string().optional(),
  nextRunAt: z.string().optional(),
  message: z.string(),
});
```
  </action>
  <verify>
```bash
npm run build
```
Build passes with new schemas.
  </verify>
  <done>AI output schemas defined for all AI-related tools</done>
</task>

<task type="auto">
  <name>Task 2: Create automation tool output schema definitions</name>
  <files>src/infrastructure/tools/schemas/automation-schemas.ts</files>
  <action>
Create src/infrastructure/tools/schemas/automation-schemas.ts:

```typescript
import { z } from "zod";

// ===== Automation Rule Schemas =====

export const AutomationTriggerSchema = z.object({
  type: z.string(),
  conditions: z.record(z.string(), z.unknown()).optional(),
});

export const AutomationActionSchema = z.object({
  type: z.string(),
  parameters: z.record(z.string(), z.unknown()).optional(),
});

export const AutomationRuleOutputSchema = z.object({
  id: z.string(),
  name: z.string(),
  description: z.string().optional(),
  enabled: z.boolean(),
  trigger: AutomationTriggerSchema,
  actions: z.array(AutomationActionSchema),
  createdAt: z.string(),
  updatedAt: z.string(),
  lastTriggeredAt: z.string().optional(),
  triggerCount: z.number().optional(),
});

export const AutomationRuleListOutputSchema = z.object({
  rules: z.array(AutomationRuleOutputSchema),
  totalCount: z.number(),
  enabledCount: z.number().optional(),
});

export const AutomationRuleToggleOutputSchema = z.object({
  id: z.string(),
  name: z.string(),
  enabled: z.boolean(),
  message: z.string(),
});

export const AutomationRuleDeleteOutputSchema = z.object({
  deleted: z.boolean(),
  id: z.string(),
  name: z.string(),
});
```
  </action>
  <verify>
```bash
npm run build
```
Build passes with new schemas.
  </verify>
  <done>Automation output schemas defined for all automation tools</done>
</task>

<task type="auto">
  <name>Task 3: Add annotations to AI and automation tool definitions</name>
  <files>src/infrastructure/tools/ToolSchemas.ts, src/infrastructure/tools/ai-tasks/*.ts</files>
  <action>
Update AI and automation tool definitions:

1. Add imports to ToolSchemas.ts:
```typescript
import {
  PRDOutputSchema,
  PRDParseOutputSchema,
  PRDEnhanceOutputSchema,
  TaskOutputSchema,
  TaskComplexityOutputSchema,
  TaskExpandOutputSchema,
  NextTaskOutputSchema,
  AddFeatureOutputSchema,
  TraceabilityMatrixOutputSchema,
  GeneratedRoadmapOutputSchema,
  EnrichedIssueOutputSchema,
  BulkEnrichOutputSchema,
  TriagedIssueOutputSchema,
  TriageAllOutputSchema,
  ScheduleTriagingOutputSchema,
} from "./schemas/ai-schemas.js";

import {
  AutomationRuleOutputSchema,
  AutomationRuleListOutputSchema,
  AutomationRuleToggleOutputSchema,
  AutomationRuleDeleteOutputSchema,
} from "./schemas/automation-schemas.js";
```

2. Update AI tool definitions in ToolSchemas.ts (or their individual files if exported there):

The AI tools are defined in separate files under ai-tasks/. Update each:

**GeneratePRDTool.ts:**
```typescript
export const generatePRDTool: ToolDefinition<GeneratePRDArgs, z.infer<typeof PRDOutputSchema>> = {
  name: "generate_prd",
  title: "Generate PRD",
  description: "Generate a Product Requirements Document using AI",
  schema: generatePRDSchema,
  outputSchema: PRDOutputSchema,
  annotations: ANNOTATION_PATTERNS.aiOperation,
};
```

**ParsePRDTool.ts:**
```typescript
export const parsePRDTool: ToolDefinition<ParsePRDArgs, z.infer<typeof PRDParseOutputSchema>> = {
  name: "parse_prd",
  title: "Parse PRD",
  description: "Parse a PRD to extract features and requirements",
  schema: parsePRDSchema,
  outputSchema: PRDParseOutputSchema,
  annotations: ANNOTATION_PATTERNS.aiOperation,
};
```

**EnhancePRDTool.ts:**
```typescript
export const enhancePRDTool: ToolDefinition<EnhancePRDArgs, z.infer<typeof PRDEnhanceOutputSchema>> = {
  name: "enhance_prd",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};
```

**AnalyzeTaskComplexityTool.ts:**
```typescript
export const analyzeTaskComplexityTool: ToolDefinition<AnalyzeTaskComplexityArgs, z.infer<typeof TaskComplexityOutputSchema>> = {
  name: "analyze_task_complexity",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};
```

**ExpandTaskTool.ts:**
```typescript
export const expandTaskTool: ToolDefinition<ExpandTaskArgs, z.infer<typeof TaskExpandOutputSchema>> = {
  name: "expand_task",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};
```

**GetNextTaskTool.ts:**
```typescript
export const getNextTaskTool: ToolDefinition<GetNextTaskArgs, z.infer<typeof NextTaskOutputSchema>> = {
  name: "get_next_task",
  annotations: {
    ...ANNOTATION_PATTERNS.aiOperation,
    readOnlyHint: true,  // Suggests but doesn't modify
  },
  // ...
};
```

**AddFeatureTool.ts:**
```typescript
export const addFeatureTool: ToolDefinition<AddFeatureArgs, z.infer<typeof AddFeatureOutputSchema>> = {
  name: "add_feature",
  annotations: ANNOTATION_PATTERNS.aiOperation,  // Also creates issues
  // ...
};
```

**CreateTraceabilityMatrixTool.ts:**
```typescript
export const createTraceabilityMatrixTool: ToolDefinition<CreateTraceabilityMatrixArgs, z.infer<typeof TraceabilityMatrixOutputSchema>> = {
  name: "create_traceability_matrix",
  annotations: {
    ...ANNOTATION_PATTERNS.aiOperation,
    readOnlyHint: true,  // Generates report, doesn't modify
  },
  // ...
};
```

3. Update automation tools in ToolSchemas.ts:

```typescript
export const createAutomationRuleTool: ToolDefinition<CreateAutomationRuleArgs, z.infer<typeof AutomationRuleOutputSchema>> = {
  name: "create_automation_rule",
  annotations: ANNOTATION_PATTERNS.create,
  // ...
};

export const updateAutomationRuleTool: ToolDefinition<UpdateAutomationRuleArgs, z.infer<typeof AutomationRuleOutputSchema>> = {
  name: "update_automation_rule",
  annotations: ANNOTATION_PATTERNS.updateIdempotent,
  // ...
};

export const deleteAutomationRuleTool: ToolDefinition<DeleteAutomationRuleArgs, z.infer<typeof AutomationRuleDeleteOutputSchema>> = {
  name: "delete_automation_rule",
  annotations: ANNOTATION_PATTERNS.delete,
  // ...
};

export const getAutomationRuleTool: ToolDefinition<GetAutomationRuleArgs, z.infer<typeof AutomationRuleOutputSchema>> = {
  name: "get_automation_rule",
  annotations: ANNOTATION_PATTERNS.readOnly,
  // ...
};

export const listAutomationRulesTool: ToolDefinition<ListAutomationRulesArgs, z.infer<typeof AutomationRuleListOutputSchema>> = {
  name: "list_automation_rules",
  annotations: ANNOTATION_PATTERNS.readOnly,
  // ...
};

export const enableAutomationRuleTool: ToolDefinition<EnableAutomationRuleArgs, z.infer<typeof AutomationRuleToggleOutputSchema>> = {
  name: "enable_automation_rule",
  annotations: ANNOTATION_PATTERNS.updateIdempotent,
  // ...
};

export const disableAutomationRuleTool: ToolDefinition<DisableAutomationRuleArgs, z.infer<typeof AutomationRuleToggleOutputSchema>> = {
  name: "disable_automation_rule",
  annotations: ANNOTATION_PATTERNS.updateIdempotent,
  // ...
};
```

4. Update AI-powered automation tools:

```typescript
export const generateRoadmapTool: ToolDefinition<GenerateRoadmapArgs, z.infer<typeof GeneratedRoadmapOutputSchema>> = {
  name: "generate_roadmap",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};

export const enrichIssueTool: ToolDefinition<EnrichIssueArgs, z.infer<typeof EnrichedIssueOutputSchema>> = {
  name: "enrich_issue",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};

export const enrichIssuesBulkTool: ToolDefinition<EnrichIssuesBulkArgs, z.infer<typeof BulkEnrichOutputSchema>> = {
  name: "enrich_issues_bulk",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};

export const triageIssueTool: ToolDefinition<TriageIssueArgs, z.infer<typeof TriagedIssueOutputSchema>> = {
  name: "triage_issue",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};

export const triageAllIssuesTool: ToolDefinition<TriageAllIssuesArgs, z.infer<typeof TriageAllOutputSchema>> = {
  name: "triage_all_issues",
  annotations: ANNOTATION_PATTERNS.aiOperation,
  // ...
};

export const scheduleTriagingTool: ToolDefinition<ScheduleTriagingArgs, z.infer<typeof ScheduleTriagingOutputSchema>> = {
  name: "schedule_triaging",
  annotations: ANNOTATION_PATTERNS.create,  // Creates a schedule
  // ...
};
```
  </action>
  <verify>
```bash
npm run build
npm test
# Verify all 84 tools now have annotations
grep -c "annotations:" src/infrastructure/tools/ToolSchemas.ts
grep -c "annotations:" src/infrastructure/tools/ai-tasks/*.ts
```
Build passes and all tools have annotations.
  </verify>
  <done>All AI and automation tools have annotations and output schemas</done>
</task>

</tasks>

<verification>
1. All 8 AI task tools have aiOperation annotations
2. All 7 automation rule tools have appropriate annotations
3. All 6 AI-powered automation tools have annotations
4. All tools have matching outputSchema
5. Build and tests pass
</verification>

<success_criteria>
- Every AI tool marked with aiOperation pattern
- Every automation tool has appropriate behavior annotation
- Output schemas match actual return types
- Schedule/create operations marked correctly
- Read-only analysis tools (traceability, get_next_task) marked as readOnlyHint
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-protocol-compliance/02-06-SUMMARY.md`
</output>
