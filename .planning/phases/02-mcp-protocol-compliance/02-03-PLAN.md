---
phase: 02-mcp-protocol-compliance
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/domain/mcp-types.ts
  - src/infrastructure/tools/ToolValidator.ts
  - src/infrastructure/mcp/MCPResponseFormatter.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "MCP error codes follow JSON-RPC 2.0 standard"
    - "GitHub API errors are wrapped with context"
    - "Protocol version mismatches return clear error message"
    - "Error payloads include code, message, and data"
  artifacts:
    - path: "src/domain/mcp-types.ts"
      provides: "Enhanced MCPErrorCode enum with standard and custom codes"
      contains: "RATE_LIMITED"
    - path: "src/infrastructure/tools/ToolValidator.ts"
      provides: "Error handling with MCP-compliant codes"
      contains: "mapGitHubError"
  key_links:
    - from: "src/infrastructure/tools/ToolValidator.ts"
      to: "@modelcontextprotocol/sdk/types.js"
      via: "McpError import"
      pattern: "McpError"
---

<objective>
Implement MCP-compliant error handling with standardized codes and rich error payloads.

Purpose: Enable clients to programmatically handle errors and provide meaningful error context.
Output: Enhanced error codes, GitHub error mapping, protocol version mismatch handling.
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mcp-protocol-compliance/02-RESEARCH.md
@.planning/phases/02-mcp-protocol-compliance/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define comprehensive MCP error codes</name>
  <files>src/domain/mcp-types.ts</files>
  <action>
Enhance the MCPErrorCode enum in mcp-types.ts to include all standard and custom codes:

```typescript
/**
 * MCP Error Codes following JSON-RPC 2.0 standard.
 *
 * Standard JSON-RPC 2.0 codes: -32700 to -32600
 * MCP-specific codes: -32000 to -32099
 * Application-specific codes: -31000 to -31999 (custom GitHub errors)
 */
export enum MCPErrorCode {
  // JSON-RPC 2.0 Standard Errors
  PARSE_ERROR = -32700,          // Invalid JSON
  INVALID_REQUEST = -32600,      // Malformed JSON-RPC
  METHOD_NOT_FOUND = -32601,     // Unknown method/tool
  INVALID_PARAMS = -32602,       // Parameter validation failed
  INTERNAL_ERROR = -32603,       // Server-side error

  // MCP-Specific Errors (-32000 to -32099)
  TOOL_EXECUTION_FAILED = -32000,
  RESOURCE_NOT_FOUND = -32001,
  PERMISSION_DENIED = -32002,

  // GitHub API Errors (Application-specific: -31000 to -31999)
  GITHUB_RATE_LIMITED = -31001,
  GITHUB_NOT_FOUND = -31002,
  GITHUB_UNAUTHORIZED = -31003,
  GITHUB_FORBIDDEN = -31004,
  GITHUB_VALIDATION_ERROR = -31005,
  GITHUB_SERVER_ERROR = -31006,

  // Protocol Errors
  PROTOCOL_VERSION_MISMATCH = -31100,

  // Legacy aliases for backward compatibility
  VALIDATION_ERROR = -32602,     // Alias for INVALID_PARAMS
}

/**
 * Error data payload structure for rich error context.
 */
export interface MCPErrorData {
  /** Tool name that caused the error, if applicable */
  tool?: string;
  /** Affected resource type and ID */
  resource?: {
    type: "project" | "issue" | "milestone" | "sprint" | "field" | "view" | "item" | "pr";
    id?: string;
  };
  /** GitHub-specific error details */
  github?: {
    status?: number;
    message?: string;
    documentation_url?: string;
  };
  /** Rate limit information if applicable */
  rateLimit?: {
    limit: number;
    remaining: number;
    reset: number;  // Unix timestamp
    retryAfter?: number;  // Seconds until retry
  };
  /** Validation error details */
  validation?: Array<{
    path: string;
    message: string;
    code: string;
  }>;
  /** Protocol version information for version mismatch errors */
  protocol?: {
    requested: string;
    supported: string[];
  };
}
```

Keep existing exports and add these new types.
  </action>
  <verify>
```bash
npm run build
```
Build passes with new types.
  </verify>
  <done>MCPErrorCode enum has all standard and custom error codes</done>
</task>

<task type="auto">
  <name>Task 2: Implement GitHub error mapping with context</name>
  <files>src/infrastructure/tools/ToolValidator.ts</files>
  <action>
Add GitHub error mapping to ToolValidator.ts:

1. Import the new types:
```typescript
import { MCPErrorCode, MCPErrorData } from "../../domain/mcp-types.js";
```

2. Add a method to map GitHub API errors:
```typescript
/**
 * Map GitHub API errors to MCP error codes with context.
 */
static mapGitHubError(error: unknown, toolName: string): McpError {
  const data: MCPErrorData = { tool: toolName };

  // Handle Octokit RequestError
  if (error && typeof error === "object" && "status" in error) {
    const status = (error as { status: number }).status;
    const message = (error as { message?: string }).message || "GitHub API error";

    data.github = { status, message };

    // Handle rate limiting
    if (status === 403 && message.toLowerCase().includes("rate limit")) {
      const headers = (error as { response?: { headers?: Record<string, string> } }).response?.headers;
      if (headers) {
        data.rateLimit = {
          limit: parseInt(headers["x-ratelimit-limit"] || "0", 10),
          remaining: parseInt(headers["x-ratelimit-remaining"] || "0", 10),
          reset: parseInt(headers["x-ratelimit-reset"] || "0", 10),
          retryAfter: parseInt(headers["retry-after"] || "0", 10),
        };
      }
      return new McpError(
        MCPErrorCode.GITHUB_RATE_LIMITED,
        `GitHub API rate limit exceeded for ${toolName}`,
        data
      );
    }

    // Map HTTP status to error code
    switch (status) {
      case 401:
        return new McpError(MCPErrorCode.GITHUB_UNAUTHORIZED, `Unauthorized: ${message}`, data);
      case 403:
        return new McpError(MCPErrorCode.GITHUB_FORBIDDEN, `Forbidden: ${message}`, data);
      case 404:
        return new McpError(MCPErrorCode.GITHUB_NOT_FOUND, `Not found: ${message}`, data);
      case 422:
        return new McpError(MCPErrorCode.GITHUB_VALIDATION_ERROR, `Validation failed: ${message}`, data);
      default:
        if (status >= 500) {
          return new McpError(MCPErrorCode.GITHUB_SERVER_ERROR, `GitHub server error: ${message}`, data);
        }
        return new McpError(MCPErrorCode.TOOL_EXECUTION_FAILED, message, data);
    }
  }

  // Handle generic errors
  if (error instanceof Error) {
    return new McpError(
      MCPErrorCode.TOOL_EXECUTION_FAILED,
      `${toolName} failed: ${error.message}`,
      { tool: toolName, stack: error.stack }
    );
  }

  return new McpError(
    MCPErrorCode.INTERNAL_ERROR,
    `Unknown error in ${toolName}`,
    { tool: toolName, error: String(error) }
  );
}
```

3. Update handleToolError to use mapGitHubError for GitHub-related errors.
  </action>
  <verify>
```bash
npm run build
npm test
```
Build passes and existing error handling tests still work.
  </verify>
  <done>GitHub API errors mapped to MCP codes with rich context</done>
</task>

<task type="auto">
  <name>Task 3: Handle protocol version mismatches</name>
  <files>src/index.ts</files>
  <action>
Add protocol version handling in src/index.ts:

1. Define supported protocol versions:
```typescript
const SUPPORTED_PROTOCOL_VERSIONS = ["2024-11-05"];
const PREFERRED_PROTOCOL_VERSION = "2024-11-05";
```

2. The MCP SDK handles version negotiation automatically in the Server constructor. However, add error handling for incompatible versions by checking the initialize handler.

Find where the server is initialized and add version checking. If using SDK 1.25.x, the server.connect() method handles this. Add explicit version logging:

```typescript
// After server.connect()
this.logger.info(`MCP server connected with protocol version ${PREFERRED_PROTOCOL_VERSION}`);
```

3. For clients that send incompatible versions, the SDK throws an error. Wrap server initialization to catch and provide helpful error:

```typescript
async connect(transport: StdioServerTransport): Promise<void> {
  try {
    await this.server.connect(transport);
    this.logger.info("MCP server connected successfully");
  } catch (error) {
    if (error instanceof McpError && error.message.includes("version")) {
      throw new McpError(
        MCPErrorCode.PROTOCOL_VERSION_MISMATCH,
        `Protocol version mismatch. Supported versions: ${SUPPORTED_PROTOCOL_VERSIONS.join(", ")}`,
        {
          protocol: {
            supported: SUPPORTED_PROTOCOL_VERSIONS,
            requested: "unknown", // Extracted from error if available
          }
        }
      );
    }
    throw error;
  }
}
```

Note: The MCP SDK 1.25.x handles version negotiation internally. This task adds explicit error messaging for debugging.
  </action>
  <verify>
```bash
npm run build
npm test
```
Build passes and server starts correctly.
  </verify>
  <done>Protocol version mismatches handled gracefully with helpful error</done>
</task>

</tasks>

<verification>
1. MCPErrorCode enum includes JSON-RPC 2.0 standard codes and GitHub-specific codes
2. GitHub API errors produce McpError with code, message, and structured data
3. Rate limit errors include retryAfter information
4. Protocol version handling provides clear error message
5. All tests pass
</verification>

<success_criteria>
- Error codes follow JSON-RPC 2.0 standard (-32xxx range)
- GitHub errors wrapped with tool context and API response details
- Rate limit errors include retry-after information
- Protocol version mismatches produce actionable error messages
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-protocol-compliance/02-03-SUMMARY.md`
</output>
