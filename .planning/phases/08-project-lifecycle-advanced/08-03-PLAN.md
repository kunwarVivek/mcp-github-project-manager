---
phase: 08-project-lifecycle-advanced
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/infrastructure/tools/project-advanced-tools.ts
  - src/infrastructure/tools/ToolRegistry.ts
  - src/infrastructure/tools/ToolSchemas.ts
autonomous: true

must_haves:
  truths:
    - "User can reorder items within a project via update_item_position tool"
    - "User can search issues with AND/OR keywords via search_issues_advanced tool"
    - "User can filter project items by status/labels/assignee via filter_project_items tool"
  artifacts:
    - path: "src/infrastructure/tools/project-advanced-tools.ts"
      provides: "3 MCP tools for advanced project operations"
      exports: ["updateItemPositionTool", "searchIssuesAdvancedTool", "filterProjectItemsTool"]
    - path: "src/infrastructure/tools/ToolRegistry.ts"
      provides: "Tool registration"
      contains: "updateItemPositionTool"
  key_links:
    - from: "project-advanced-tools.ts"
      to: "project-lifecycle-schemas.ts"
      via: "schema imports"
      pattern: "import.*from.*project-lifecycle-schemas"
    - from: "ToolRegistry.ts"
      to: "project-advanced-tools.ts"
      via: "registerTool calls"
      pattern: "this\\.registerTool\\(updateItemPositionTool\\)"
---

<objective>
Create 3 MCP tools for advanced project operations: update item position (GHAPI-22), search issues advanced (GHAPI-23), and filter project items (GHAPI-24).

Purpose: Enable users to reorder items, search with complex queries, and filter project items.
Output: One tools file with 3 tool definitions and executors, plus ToolRegistry updates.
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-project-lifecycle-advanced/08-RESEARCH.md

Reference existing tool patterns:
@src/infrastructure/tools/project-template-tools.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project-advanced-tools.ts with 3 tools</name>
  <files>src/infrastructure/tools/project-advanced-tools.ts</files>
  <action>
Create `src/infrastructure/tools/project-advanced-tools.ts` with 3 MCP tools for advanced operations.

**File Structure:**

1. **Header comment** - Document the 3 tools (GHAPI-22 to GHAPI-24)

2. **Imports:**
   - ToolDefinition, ToolSchema from ToolValidator.js
   - ANNOTATION_PATTERNS from annotations/tool-annotations.js
   - GitHubRepositoryFactory from ../github/GitHubRepositoryFactory.js
   - All relevant input/output schemas from ./schemas/project-lifecycle-schemas.js

3. **GraphQL Queries/Mutations:**

```typescript
const UPDATE_ITEM_POSITION_MUTATION = `
  mutation UpdateProjectV2ItemPosition($input: UpdateProjectV2ItemPositionInput!) {
    updateProjectV2ItemPosition(input: $input) {
      items(first: 5) {
        nodes {
          id
        }
      }
    }
  }
`;

const SEARCH_ISSUES_ADVANCED_QUERY = `
  query SearchIssuesAdvanced($query: String!, $first: Int!, $after: String) {
    search(query: $query, type: ISSUE_ADVANCED, first: $first, after: $after) {
      issueCount
      nodes {
        ... on Issue {
          id
          number
          title
          state
          url
          labels(first: 10) {
            nodes { name }
          }
          assignees(first: 5) {
            nodes { login }
          }
          repository {
            nameWithOwner
          }
        }
      }
      pageInfo {
        hasNextPage
        endCursor
      }
    }
  }
`;

const LIST_PROJECT_ITEMS_QUERY = `
  query ListProjectItems($projectId: ID!, $first: Int!, $after: String) {
    node(id: $projectId) {
      ... on ProjectV2 {
        items(first: $first, after: $after) {
          totalCount
          nodes {
            id
            content {
              __typename
              ... on Issue {
                id
                title
                state
                labels(first: 10) { nodes { name } }
              }
              ... on PullRequest {
                id
                title
                state
              }
              ... on DraftIssue {
                id
                title
              }
            }
            fieldValues(first: 20) {
              nodes {
                ... on ProjectV2ItemFieldSingleSelectValue {
                  name
                  field { ... on ProjectV2SingleSelectField { name } }
                }
                ... on ProjectV2ItemFieldTextValue {
                  text
                  field { ... on ProjectV2Field { name } }
                }
              }
            }
          }
          pageInfo {
            hasNextPage
            endCursor
          }
        }
      }
    }
  }
`;
```

4. **Helper Functions:**

```typescript
function createFactory(): GitHubRepositoryFactory {
  const token = process.env.GITHUB_TOKEN;
  if (!token) {
    throw new Error("GITHUB_TOKEN environment variable is required");
  }
  return new GitHubRepositoryFactory(token, "placeholder", "placeholder");
}

// Client-side filtering helper (IMPORTANT: GitHub API has no server-side filtering)
function matchesFilter(item: ProjectItemNode, filter: FilterCriteria): boolean {
  if (filter.type && item.content.__typename !== filter.type) return false;
  if (filter.status) {
    const statusField = item.fieldValues.nodes.find(
      (fv) => fv.field?.name === 'Status'
    );
    if (!statusField || statusField.name !== filter.status) return false;
  }
  if (filter.labels?.length) {
    const itemLabels = item.content.labels?.nodes.map(l => l.name) || [];
    if (!filter.labels.some(l => itemLabels.includes(l))) return false;
  }
  if (filter.assignee) {
    const itemAssignees = item.content.assignees?.nodes.map(a => a.login) || [];
    if (!itemAssignees.includes(filter.assignee)) return false;
  }
  return true;
}
```

5. **GraphQL Response Types** (define all needed interfaces)

6. **Tool Definitions:**

**updateItemPositionTool (GHAPI-22):**
- name: "update_item_position"
- title: "Update Item Position"
- description: "Reorders an item within a GitHub ProjectV2. If afterId is omitted, the item moves to the first position. Position changes persist across views."
- schema: UpdateItemPositionInputSchema
- outputSchema: ItemPositionOutputSchema
- annotations: ANNOTATION_PATTERNS.update
- examples: move item to top, move item after another item

**searchIssuesAdvancedTool (GHAPI-23):**
- name: "search_issues_advanced"
- title: "Search Issues with Advanced Query"
- description: "Searches GitHub issues using advanced query syntax with AND/OR operators. Use explicit 'AND' and 'OR' keywords for complex queries. Example: 'is:issue AND repo:owner/repo AND (label:bug OR label:critical)'."
- schema: SearchIssuesAdvancedInputSchema
- outputSchema: SearchIssuesOutputSchema
- annotations: ANNOTATION_PATTERNS.readOnly
- examples: search with AND, search with OR grouping

**filterProjectItemsTool (GHAPI-24):**
- name: "filter_project_items"
- title: "Filter Project Items"
- description: "Filters items in a GitHub ProjectV2 by status, labels, assignee, or type. Note: Filtering is performed client-side as GitHub's API does not support server-side filtering for project items."
- schema: FilterProjectItemsInputSchema
- outputSchema: FilterProjectItemsOutputSchema
- annotations: ANNOTATION_PATTERNS.readOnly
- examples: filter by status, filter by labels, filter by type

7. **Executor Functions:**

**executeUpdateItemPosition:**
- Use UPDATE_ITEM_POSITION_MUTATION with { projectId, itemId, afterId? }
- Return success status and position description

**executeSearchIssuesAdvanced:**
- Use SEARCH_ISSUES_ADVANCED_QUERY
- Map response to SearchIssuesOutput format
- Note: Fall back to ISSUE type if ISSUE_ADVANCED fails (new feature)

**executeFilterProjectItems:**
- Fetch all items with LIST_PROJECT_ITEMS_QUERY (paginated)
- Apply client-side filtering using matchesFilter helper
- Return filtered results with counts

All executors follow the return format:
```typescript
return {
  content: [{ type: "text", text: JSON.stringify(result, null, 2) }],
  structuredContent: result
};
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/infrastructure/tools/project-advanced-tools.ts
```
TypeScript compilation succeeds.
  </verify>
  <done>
3 tool definitions and 3 executor functions are implemented with proper GraphQL queries and client-side filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register advanced tools in ToolRegistry</name>
  <files>src/infrastructure/tools/ToolRegistry.ts</files>
  <action>
Update `src/infrastructure/tools/ToolRegistry.ts` to import and register the 3 advanced operation tools.

**Add imports** (after project-lifecycle-tools imports):
```typescript
import {
  updateItemPositionTool,
  searchIssuesAdvancedTool,
  filterProjectItemsTool,
} from "./project-advanced-tools.js";
```

**Add registration** (after Project Lifecycle section):
```typescript
    // Advanced Operations (Phase 8)
    this.registerTool(updateItemPositionTool);
    this.registerTool(searchIssuesAdvancedTool);
    this.registerTool(filterProjectItemsTool);
```

**Also update ToolSchemas.ts** to re-export tools:

Add at the end of the file (after Project Lifecycle section):
```typescript
// ============================================================================
// Advanced Operations Tools
// ============================================================================

// Re-export advanced operations tools
export {
  updateItemPositionTool,
  searchIssuesAdvancedTool,
  filterProjectItemsTool,
  executeUpdateItemPosition,
  executeSearchIssuesAdvanced,
  executeFilterProjectItems,
} from "./project-advanced-tools.js";
```

This completes Phase 8 tool registration (6 total new tools, bringing total to 109).
  </action>
  <verify>
```bash
npx tsc --noEmit src/infrastructure/tools/ToolRegistry.ts
```
TypeScript compilation succeeds.
  </verify>
  <done>
All 3 advanced tools are imported and registered in ToolRegistry.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compilation:
```bash
npx tsc --noEmit
```
No errors in the full build.

2. Tools exported:
```bash
grep -c "export const.*Tool" src/infrastructure/tools/project-advanced-tools.ts
```
Should return 3.

3. Executors exported:
```bash
grep -c "export async function execute" src/infrastructure/tools/project-advanced-tools.ts
```
Should return 3.

4. Client-side filter helper exists:
```bash
grep -c "matchesFilter" src/infrastructure/tools/project-advanced-tools.ts
```
Should return 2+ (definition and usage).

5. All Phase 8 tools registered:
```bash
grep -c "Lifecycle\|Advanced Operations" src/infrastructure/tools/ToolRegistry.ts
```
Should return 2 (comment lines for each section).
</verification>

<success_criteria>
- updateItemPositionTool reorders items via GraphQL mutation
- searchIssuesAdvancedTool searches with AND/OR query syntax (ISSUE_ADVANCED type)
- filterProjectItemsTool applies client-side filtering (documented limitation)
- All tools have proper annotations, schemas, and examples
- Tools are registered in ToolRegistry
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-project-lifecycle-advanced/08-03-SUMMARY.md`
</output>
