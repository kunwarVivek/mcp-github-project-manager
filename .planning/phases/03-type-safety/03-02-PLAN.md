---
phase: 03-type-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/type-guards.ts
  - src/infrastructure/github/rest-types.ts
  - src/infrastructure/github/GitHubErrorHandler.ts
  - src/infrastructure/cache/ResourceCache.ts
  - src/services/IssueEnrichmentService.ts
autonomous: true

must_haves:
  truths:
    - "External data is validated with type guards before property access"
    - "Type guards use Zod safeParse for consistent validation"
    - "Unknown data never requires as any to access properties"
  artifacts:
    - path: "src/domain/type-guards.ts"
      provides: "Centralized type guards for external data"
      exports: ["isProjectItem", "isCacheableResource", "isRestUser", "isGitHubErrorWithCode"]
    - path: "src/infrastructure/cache/ResourceCache.ts"
      provides: "Cache with typed resource handling"
      pattern: "isCacheableResource"
    - path: "src/services/IssueEnrichmentService.ts"
      provides: "Issue enrichment with typed item access"
      pattern: "isProjectItem"
  key_links:
    - from: "ResourceCache.ts"
      to: "type-guards.ts"
      via: "import and guard usage"
      pattern: "isCacheableResource\\(value\\)"
    - from: "IssueEnrichmentService.ts"
      to: "type-guards.ts"
      via: "import and guard usage"
      pattern: "isProjectItem\\(item\\)"
---

<objective>
Create type guards for external data boundaries and eliminate `as any` for unknown data access.

Purpose: Establish type-safe patterns for handling external data (GitHub API responses, cached resources, error objects) that can be reused across the codebase.
Output: New type-guards.ts module with 4 type guards, 5 files updated to use guards instead of `as any`.
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-type-safety/03-RESEARCH.md

@src/infrastructure/github/rest-types.ts
@src/infrastructure/github/GitHubErrorHandler.ts
@src/infrastructure/cache/ResourceCache.ts
@src/services/IssueEnrichmentService.ts
@src/infrastructure/github/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized type guards module</name>
  <files>src/domain/type-guards.ts</files>
  <action>
Create a new file `src/domain/type-guards.ts` with type guards for external data:

1. **isProjectItem** - For GitHub project items with title/content:
```typescript
import { z } from 'zod';

const ProjectItemSchema = z.object({
  title: z.string().optional(),
  content: z.object({
    body: z.string().optional()
  }).optional()
});

export type ProjectItem = z.infer<typeof ProjectItemSchema>;

export function isProjectItem(data: unknown): data is ProjectItem {
  return ProjectItemSchema.safeParse(data).success;
}
```

2. **isCacheableResource** - For cached values with metadata:
```typescript
const CacheableResourceSchema = z.object({
  updatedAt: z.string().optional(),
  version: z.number().optional()
});

export type CacheableResource = z.infer<typeof CacheableResourceSchema>;

export function isCacheableResource(data: unknown): data is CacheableResource {
  return typeof data === 'object' && data !== null;
}
```

3. **isRestUser** - For GitHub REST API user objects:
```typescript
const RestUserSchema = z.object({
  avatar_url: z.string().optional(),
  gravatar_id: z.string().nullable().optional(),
  url: z.string().optional()
});

export type RestUserProperties = z.infer<typeof RestUserSchema>;

export function hasRestUserProperties(user: unknown): user is RestUserProperties {
  return typeof user === 'object' && user !== null;
}
```

4. **isGitHubErrorWithCode** - For errors with code property:
```typescript
export function isGitHubErrorWithCode(error: unknown): error is { code: string } {
  return typeof error === 'object' &&
         error !== null &&
         'code' in error &&
         typeof (error as { code: unknown }).code === 'string';
}
```

Export all type guards and types.
  </action>
  <verify>
```bash
# Verify file exists with exports
grep -n "export function" src/domain/type-guards.ts
grep -n "export type" src/domain/type-guards.ts
```
  </verify>
  <done>type-guards.ts exists with 4 type guards and associated types</done>
</task>

<task type="auto">
  <name>Task 2: Apply type guards to infrastructure files</name>
  <files>
src/infrastructure/github/rest-types.ts
src/infrastructure/github/GitHubErrorHandler.ts
src/infrastructure/cache/ResourceCache.ts
  </files>
  <action>
Update infrastructure files to use type guards:

**rest-types.ts (lines 244-246):**
- Import `hasRestUserProperties` from `../../domain/type-guards`
- Replace:
```typescript
avatar_url: (user as any).avatar_url,
gravatar_id: (user as any).gravatar_id ?? null,
url: (user as any).url,
```
With:
```typescript
avatar_url: hasRestUserProperties(user) ? user.avatar_url : undefined,
gravatar_id: hasRestUserProperties(user) ? (user.gravatar_id ?? null) : null,
url: hasRestUserProperties(user) ? user.url : undefined,
```

**GitHubErrorHandler.ts (line 77):**
- Import `isGitHubErrorWithCode` from `../../domain/type-guards`
- Replace: `const code = (error as any).code;`
- With: `const code = isGitHubErrorWithCode(error) ? error.code : undefined;`

**ResourceCache.ts (lines 59-60):**
- Import `isCacheableResource` from `../../domain/type-guards`
- Replace:
```typescript
lastModified: (value as any).updatedAt || new Date().toISOString(),
version: (value as any).version || 1,
```
With:
```typescript
lastModified: isCacheableResource(value) && value.updatedAt ? value.updatedAt : new Date().toISOString(),
version: isCacheableResource(value) && value.version ? value.version : 1,
```
  </action>
  <verify>
```bash
# Verify no as any in modified sections
echo "=== rest-types.ts user as any ==="
grep -n "user as any" src/infrastructure/github/rest-types.ts && echo "FAIL" || echo "PASS"

echo "=== GitHubErrorHandler error as any ==="
grep -n "error as any" src/infrastructure/github/GitHubErrorHandler.ts && echo "FAIL" || echo "PASS"

echo "=== ResourceCache value as any ==="
grep -n "value as any" src/infrastructure/cache/ResourceCache.ts && echo "FAIL" || echo "PASS"
```
  </verify>
  <done>Infrastructure files use type guards instead of as any for external data</done>
</task>

<task type="auto">
  <name>Task 3: Apply type guard to IssueEnrichmentService</name>
  <files>src/services/IssueEnrichmentService.ts</files>
  <action>
Update IssueEnrichmentService to use type guards:

**IssueEnrichmentService.ts (lines 82-83):**
- Import `isProjectItem` from `../domain/type-guards`
- Replace:
```typescript
issueTitle: (item as any).title || 'Untitled',
issueDescription: (item as any).content?.body
```
With:
```typescript
issueTitle: isProjectItem(item) && item.title ? item.title : 'Untitled',
issueDescription: isProjectItem(item) ? item.content?.body : undefined
```

Run TypeScript compilation to verify all changes are type-correct.
  </action>
  <verify>
```bash
# Verify no as any for item
echo "=== IssueEnrichmentService item as any ==="
grep -n "item as any" src/services/IssueEnrichmentService.ts && echo "FAIL" || echo "PASS"

# TypeScript compilation
cd /Users/vivek/jet/mcp-github-project-manager && npx tsc --noEmit && echo "TypeScript: PASS"
```
  </verify>
  <done>IssueEnrichmentService uses type guards for project item access</done>
</task>

</tasks>

<verification>
```bash
cd /Users/vivek/jet/mcp-github-project-manager

# Count as any removals
echo "=== External data as any remaining ==="
grep -c "as any" src/infrastructure/github/rest-types.ts || echo "0 in rest-types"
grep -c "error as any" src/infrastructure/github/GitHubErrorHandler.ts || echo "0 error casts in GitHubErrorHandler"
grep -c "value as any" src/infrastructure/cache/ResourceCache.ts || echo "0 in ResourceCache"
grep -c "item as any" src/services/IssueEnrichmentService.ts || echo "0 in IssueEnrichmentService"

# Type guards exist
echo "=== Type guards created ==="
grep "export function" src/domain/type-guards.ts | wc -l

# TypeScript passes
npx tsc --noEmit && echo "TypeScript: PASS" || echo "TypeScript: FAIL"
```
</verification>

<success_criteria>
1. type-guards.ts exists with 4 exported type guards
2. Zero `user as any` in rest-types.ts
3. Zero `error as any` in GitHubErrorHandler.ts (for the code access pattern)
4. Zero `value as any` in ResourceCache.ts
5. Zero `item as any` in IssueEnrichmentService.ts
6. TypeScript compiles without errors
7. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-type-safety/03-02-SUMMARY.md`
</output>
