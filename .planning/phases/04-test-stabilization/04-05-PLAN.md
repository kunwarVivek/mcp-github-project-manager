---
phase: 04-test-stabilization
plan: 05
type: execute
wave: 3
depends_on: [04-03, 04-04]
files_modified:
  - .planning/phases/04-test-stabilization/04-VERIFICATION.md
autonomous: true

must_haves:
  truths:
    - "npm test reports 0 failing tests"
    - "No skipped tests without documented justification"
    - "Code coverage is 80% or higher"
    - "All DEBT-14 through DEBT-20 requirements are satisfied"
  artifacts:
    - path: ".planning/phases/04-test-stabilization/04-VERIFICATION.md"
      provides: "Phase verification results"
      contains: "PHASE COMPLETE"
  key_links:
    - from: "test suite"
      to: "coverage report"
      via: "npm test --coverage"
      pattern: "80%"
---

<objective>
Verify all Phase 4 success criteria and document the final state.

Purpose: Confirm that test stabilization is complete by running the full test suite and coverage analysis. Document any remaining issues for future phases.

Output: Verification report confirming phase completion with metrics.
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-stabilization/04-01-SUMMARY.md
@.planning/phases/04-test-stabilization/04-02-SUMMARY.md
@.planning/phases/04-test-stabilization/04-03-SUMMARY.md
@.planning/phases/04-test-stabilization/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite and capture results</name>
  <files>n/a</files>
  <action>
Run the complete test suite and capture the results:

```bash
npm test 2>&1 | tee /tmp/test-results.txt
```

Analyze the output for:
1. Total tests: passed, failed, skipped
2. Test suites: passed, failed, skipped
3. Any remaining failures (categorize by type)
4. Any warnings or deprecation notices

If there are still failing tests:
1. Identify the root cause
2. If fixable, create a simple fix
3. If requires significant work, document for gap closure

Expected outcome: 0 failing tests
  </action>
  <verify>
```bash
npm test 2>&1 | grep -E "^Tests:"
```

Should show: `Tests: X passed, 0 failed, Y skipped, Z total` (or similar with 0 failed)
  </verify>
  <done>Test suite runs with 0 failing tests.</done>
</task>

<task type="auto">
  <name>Task 2: Generate and analyze coverage report</name>
  <files>n/a</files>
  <action>
Run tests with coverage and analyze:

```bash
npm test -- --coverage --coverageReporters=text-summary --coverageReporters=json-summary 2>&1 | tee /tmp/coverage-results.txt
```

Extract key metrics:
1. Overall statement coverage
2. Overall branch coverage
3. Overall function coverage
4. Overall line coverage

Check specific file coverage:
```bash
npm test -- --coverage --collectCoverageFrom="src/services/context/*.ts" --collectCoverageFrom="src/services/validation/*.ts" 2>&1 | grep -E "(ContextualReference|DependencyContext|ContextQuality)"
```

Verify:
- Overall coverage >= 80%
- ContextualReferenceGenerator >= 90%
- DependencyContextGenerator >= 80%
- ContextQualityValidator >= 80%

If coverage is below targets:
1. Identify uncovered code paths
2. Add targeted tests if simple fixes
3. Document gaps for future work if complex
  </action>
  <verify>
```bash
npm test -- --coverage 2>&1 | grep -E "All files|Statements|Branches|Functions|Lines" | head -5
```

All metrics should show >= 80%.
  </verify>
  <done>Coverage report shows 80%+ overall coverage.</done>
</task>

<task type="auto">
  <name>Task 3: Document skipped tests and justifications</name>
  <files>n/a</files>
  <action>
Identify all skipped tests:

```bash
npm test -- --verbose 2>&1 | grep -E "skipped|SKIP" | head -20
```

For each skipped test, verify there is a documented justification:

1. E2E tests skipped due to missing credentials: **JUSTIFIED** - CI environments may not have GitHub tokens
2. Tests skipped due to missing AI keys: **JUSTIFIED** - AI services are optional

Document any skipped tests that lack justification and either:
- Add justification comment in the test
- Fix the test so it doesn't need to skip

Create a summary of skipped tests and their justifications.
  </action>
  <verify>
All skipped tests have documented justification (either in code comments or in the verification report).
  </verify>
  <done>All skipped tests have documented justification.</done>
</task>

<task type="auto">
  <name>Task 4: Create verification report</name>
  <files>.planning/phases/04-test-stabilization/04-VERIFICATION.md</files>
  <action>
Create the verification report documenting phase completion:

```markdown
# Phase 4: Test Stabilization - Verification

**Verified:** [DATE]
**Status:** PHASE COMPLETE

## Test Results

| Metric | Before | After | Target | Status |
|--------|--------|-------|--------|--------|
| Failing tests | 44 | 0 | 0 | PASS |
| Passing tests | 341 | [N] | N/A | N/A |
| Skipped tests | 20 | [M] | Justified | PASS |
| Total tests | 405 | [T] | N/A | N/A |

## Coverage Results

| Metric | Value | Target | Status |
|--------|-------|--------|--------|
| Statements | [X]% | 80% | PASS/FAIL |
| Branches | [Y]% | 75% | PASS/FAIL |
| Functions | [Z]% | 80% | PASS/FAIL |
| Lines | [W]% | 80% | PASS/FAIL |

### Key File Coverage

| File | Statements | Target | Status |
|------|------------|--------|--------|
| ContextualReferenceGenerator.ts | [X]% | 90% | PASS/FAIL |
| DependencyContextGenerator.ts | [Y]% | 80% | PASS/FAIL |
| ContextQualityValidator.ts | [Z]% | 80% | PASS/FAIL |

## Requirement Verification

| Requirement | Description | Status |
|-------------|-------------|--------|
| DEBT-14 | Fix failing tests | PASS |
| DEBT-15 | Enable and fix skipped tests | PASS |
| DEBT-16 | Unit tests for ContextualReferenceGenerator | PASS |
| DEBT-17 | Unit tests for DependencyContextGenerator | PASS |
| DEBT-18 | Unit tests for ContextQualityValidator | PASS |
| DEBT-19 | Integration tests for GitHub features | PASS/PARTIAL |
| DEBT-20 | 80%+ code coverage | PASS |

## Skipped Tests Justification

| Test Suite | Count | Justification |
|------------|-------|---------------|
| E2E GitHub tools | N | Missing GITHUB_TOKEN in CI |
| E2E AI tools | M | Missing AI API keys in CI |

## Success Criteria Verification

1. `npm test` reports 0 failing tests: [X] PASS
2. No skipped tests without documented justification: [X] PASS
3. Code coverage is 80% or higher: [X] PASS
4. ContextualReferenceGenerator has 90%+ coverage: [X] PASS
5. All AI fallback paths have test coverage: [X] PASS

## Notes

[Any additional notes or observations]
```

Fill in actual values from the test runs.
  </action>
  <verify>
The verification file exists and shows PHASE COMPLETE with all success criteria met.
  </verify>
  <done>04-VERIFICATION.md created documenting phase completion.</done>
</task>

</tasks>

<verification>
Final verification:
```bash
npm test 2>&1 | tail -5
cat .planning/phases/04-test-stabilization/04-VERIFICATION.md | head -20
```

Expected:
- Test suite shows 0 failures
- Verification report shows PHASE COMPLETE
</verification>

<success_criteria>
1. npm test: 0 failing tests
2. Coverage: 80%+ overall
3. ContextualReferenceGenerator: 90%+ coverage
4. DependencyContextGenerator: 80%+ coverage
5. ContextQualityValidator: 80%+ coverage
6. All skipped tests have documented justification
7. 04-VERIFICATION.md exists with PHASE COMPLETE status
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-stabilization/04-05-SUMMARY.md`
</output>
