---
phase: 04-test-stabilization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/__tests__/e2e/tools/ai-task-tools.e2e.ts
  - src/__tests__/e2e/tools/github-project-tools.e2e.ts
  - src/__tests__/e2e/utils/MCPToolTestUtils.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests skip gracefully when GitHub credentials are missing"
    - "No 'Bad credentials' or 'Authentication failed' errors in test output"
    - "Tests that depend on prior test state handle undefined utils gracefully"
  artifacts:
    - path: "src/__tests__/e2e/tools/ai-task-tools.e2e.ts"
      provides: "Credential-guarded E2E tests"
      contains: "if (!utils)"
    - path: "src/__tests__/e2e/tools/github-project-tools.e2e.ts"
      provides: "Credential-guarded E2E tests"
      contains: "if (!utils)"
  key_links:
    - from: "beforeAll credential check"
      to: "individual test guards"
      via: "utils undefined check"
      pattern: "if.*!utils"
---

<objective>
Add proper credential guards to E2E tests that require GitHub authentication.

Purpose: E2E tests should skip gracefully when credentials are unavailable (CI environments, fresh clones) rather than failing with authentication errors.

Output: All E2E tests either pass with valid credentials or skip cleanly without credentials.
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-stabilization/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add credential guards to ai-task-tools.e2e.ts</name>
  <files>src/__tests__/e2e/tools/ai-task-tools.e2e.ts</files>
  <action>
The file uses `MCPToolTestUtils.createTestSuite()` pattern which handles some credential checking, but individual tests that depend on `utils` methods fail when utils is undefined.

Add guard at the start of each test that uses utils:
```typescript
it('should list all AI task management tools', async () => {
  if (!utils) {
    console.log('Skipping: utils not initialized');
    return;
  }
  const tools = await utils.listTools();
  // ... rest of test
});
```

Add this guard pattern to ALL tests that call:
- `utils.listTools()`
- `utils.callTool()`
- `utils.testToolValidation()`
- `utils.validateToolExists()`

This is approximately 15 tests in the file.

Alternative approach: Check if the createTestSuite wrapper already provides a guard mechanism. If so, ensure the wrapper correctly short-circuits when credentials are missing.

The key issue is that `utils` is undefined when credentials are missing, so any test calling `utils.anything()` will throw TypeError.
  </action>
  <verify>
Run tests without GitHub token:
```bash
GITHUB_TOKEN= npm test -- --testPathPattern="ai-task-tools.e2e" 2>&1 | grep -E "(skip|TypeError|undefined)"
```

Should see skip messages, NOT TypeError about undefined.
  </verify>
  <done>ai-task-tools.e2e.ts tests skip gracefully when utils is undefined.</done>
</task>

<task type="auto">
  <name>Task 2: Add credential guards to github-project-tools.e2e.ts</name>
  <files>src/__tests__/e2e/tools/github-project-tools.e2e.ts</files>
  <action>
Similar to Task 1, but this file doesn't use createTestSuite wrapper - it has explicit beforeAll/afterAll.

The beforeAll at lines 15-22 already checks credentials and returns early, but `utils` is still accessed in tests when it's undefined.

Add guard at start of each test:
```typescript
it('should list all project tools', async () => {
  if (!utils) {
    console.log('Skipping: utils not initialized');
    return;
  }
  const tools = await utils.listTools();
  // ...
});
```

Apply to all tests that access `utils`:
- Project Tools describe block (6 tests)
- Milestone Tools describe block (4 tests)
- Issue Tools describe block (5 tests)
- Sprint Tools describe block (4 tests)
- Roadmap and Planning Tools describe block (4 tests)
- Label Tools describe block (3 tests)

Total: ~26 tests need the guard.
  </action>
  <verify>
Run tests without GitHub token:
```bash
GITHUB_TOKEN= npm test -- --testPathPattern="github-project-tools.e2e" 2>&1 | grep -E "(skip|TypeError|undefined)"
```

Should see skip messages, NOT TypeError about undefined.
  </verify>
  <done>github-project-tools.e2e.ts tests skip gracefully when utils is undefined.</done>
</task>

</tasks>

<verification>
Run all E2E tests without credentials:
```bash
GITHUB_TOKEN= npm test -- --testPathPattern="e2e" 2>&1 | tail -10
```

Expected: Tests should show as passed (with early returns) or skipped, not failed.

Then run with credentials (if available):
```bash
npm test -- --testPathPattern="e2e" 2>&1 | tail -10
```

Expected: Tests should pass normally.
</verification>

<success_criteria>
1. No TypeError about undefined utils in E2E tests
2. Tests skip gracefully when GITHUB_TOKEN is unset
3. Tests run normally when credentials are available
4. Zero authentication-related test failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-stabilization/04-02-SUMMARY.md`
</output>
