---
phase: 10-ai-sprint-roadmap-planning
plan: 04
type: execute
wave: 3
depends_on: ["10-02", "10-03"]
files_modified:
  - src/infrastructure/tools/sprint-ai-tools.ts
  - src/infrastructure/tools/roadmap-ai-tools.ts
  - src/infrastructure/tools/ToolRegistry.ts
  - tests/ai-services/SprintCapacityAnalyzer.test.ts
  - tests/ai-services/BacklogPrioritizer.test.ts
  - tests/ai-services/SprintRiskAssessor.test.ts
  - tests/ai-services/RoadmapAIService.test.ts
  - docs/TOOLS.md
  - .planning/STATE.md
autonomous: true

must_haves:
  truths:
    - "MCP tools expose all 8 AI requirements (AI-09 to AI-16)"
    - "Tools have proper annotations (aiOperation for generation, readOnly for analysis)"
    - "Tools are registered in ToolRegistry"
    - "Services have 80%+ test coverage"
  artifacts:
    - path: "src/infrastructure/tools/sprint-ai-tools.ts"
      provides: "MCP tools for sprint AI features"
      exports: ["suggestSprintCompositionTool", "assessSprintRiskTool", "prioritizeBacklogTool"]
    - path: "src/infrastructure/tools/roadmap-ai-tools.ts"
      provides: "MCP tools for roadmap AI features"
      exports: ["generateRoadmapTool", "generateVisualizationTool"]
    - path: "tests/ai-services/SprintCapacityAnalyzer.test.ts"
      provides: "Unit tests for capacity analyzer"
      min_lines: 150
  key_links:
    - from: "src/infrastructure/tools/ToolRegistry.ts"
      to: "src/infrastructure/tools/sprint-ai-tools.ts"
      via: "Tool registration"
      pattern: "registerTool.*sprint"
    - from: "src/infrastructure/tools/sprint-ai-tools.ts"
      to: "src/services/ai/SprintSuggestionService.ts"
      via: "Executor calls service"
      pattern: "SprintSuggestionService"
---

<objective>
Create MCP tools for sprint and roadmap AI features, add comprehensive tests, and update documentation.

Purpose: Expose all 8 Phase 10 AI requirements (AI-09 to AI-16) as MCP tools with proper testing.

Output:
- MCP tools for sprint planning (4 tools: capacity, prioritization, risk, suggestion)
- MCP tools for roadmap planning (2 tools: generate, visualize)
- Unit tests for all AI services (150+ tests)
- Documentation updates (TOOLS.md, STATE.md)
</objective>

<execution_context>
@/Users/vivek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vivek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ai-sprint-roadmap-planning/10-RESEARCH.md
@.planning/phases/10-ai-sprint-roadmap-planning/10-02-SUMMARY.md
@.planning/phases/10-ai-sprint-roadmap-planning/10-03-SUMMARY.md
@src/infrastructure/tools/annotations/tool-annotations.ts
@src/infrastructure/tools/ToolRegistry.ts
@src/services/ai/SprintSuggestionService.ts
@src/services/ai/RoadmapAIService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sprint AI MCP tools</name>
  <files>src/infrastructure/tools/sprint-ai-tools.ts</files>
  <action>
Create MCP tools for sprint AI features following existing tool patterns (see project-lifecycle-tools.ts):

```typescript
import { z } from 'zod';
import { ANNOTATION_PATTERNS } from './annotations/tool-annotations';
import { ToolDefinition } from './ToolValidator';
import { SprintSuggestionService } from '../../services/ai/SprintSuggestionService';
import { SprintCapacityAnalyzer } from '../../services/ai/SprintCapacityAnalyzer';
import { BacklogPrioritizer } from '../../services/ai/BacklogPrioritizer';
import { SprintRiskAssessor } from '../../services/ai/SprintRiskAssessor';
import {
  SprintCapacityInputSchema,
  SprintSuggestionInputSchema,
  BacklogPrioritizationInputSchema,
  SprintRiskInputSchema,
  SprintCapacityOutputSchema,
  SprintSuggestionOutputSchema,
  PrioritizationOutputSchema,
  SprintRiskOutputSchema
} from './schemas/sprint-roadmap-schemas';

// ============================================================================
// Tool Definitions
// ============================================================================

/**
 * calculate_sprint_capacity - AI-09: Calculate sprint capacity with velocity
 */
export const calculateSprintCapacityTool: ToolDefinition = {
  name: 'calculate_sprint_capacity',
  title: 'Calculate Sprint Capacity',
  description: 'Calculate sprint capacity based on team velocity, availability, and buffer. Returns recommended story points for the sprint.',
  annotations: ANNOTATION_PATTERNS.readOnly, // Analysis, safe to cache
  inputSchema: SprintCapacityInputSchema,
  outputSchema: SprintCapacityOutputSchema
};

/**
 * prioritize_backlog - AI-10: Multi-factor backlog prioritization
 */
export const prioritizeBacklogTool: ToolDefinition = {
  name: 'prioritize_backlog',
  title: 'Prioritize Backlog',
  description: 'AI-powered backlog prioritization using business value, dependencies, risk, and effort. Returns prioritized items with reasoning.',
  annotations: ANNOTATION_PATTERNS.aiOperation, // AI non-deterministic
  inputSchema: BacklogPrioritizationInputSchema,
  outputSchema: PrioritizationOutputSchema
};

/**
 * assess_sprint_risk - AI-11: Sprint risk assessment
 */
export const assessSprintRiskTool: ToolDefinition = {
  name: 'assess_sprint_risk',
  title: 'Assess Sprint Risk',
  description: 'Analyze sprint plan for potential risks. Identifies scope, dependency, capacity, technical, and external risks with mitigation suggestions.',
  annotations: ANNOTATION_PATTERNS.aiOperation, // AI non-deterministic
  inputSchema: SprintRiskInputSchema,
  outputSchema: SprintRiskOutputSchema
};

/**
 * suggest_sprint_composition - AI-12: Velocity-based scope recommendations
 */
export const suggestSprintCompositionTool: ToolDefinition = {
  name: 'suggest_sprint_composition',
  title: 'Suggest Sprint Composition',
  description: 'AI-powered sprint composition suggestion. Selects backlog items that fit capacity while respecting dependencies and business priorities.',
  annotations: ANNOTATION_PATTERNS.aiOperation, // AI non-deterministic
  inputSchema: SprintSuggestionInputSchema,
  outputSchema: SprintSuggestionOutputSchema
};

// ============================================================================
// Tool Executors
// ============================================================================

export async function executeCalculateSprintCapacity(
  args: z.infer<typeof SprintCapacityInputSchema>
): Promise<z.infer<typeof SprintCapacityOutputSchema>> {
  const analyzer = new SprintCapacityAnalyzer();
  return analyzer.calculateCapacity({
    velocity: args.velocity,
    sprintDurationDays: args.sprintDurationDays,
    teamMembers: args.teamMembers || [],
    historicalSprints: args.historicalSprints
  });
}

export async function executePrioritizeBacklog(
  args: z.infer<typeof BacklogPrioritizationInputSchema>
): Promise<z.infer<typeof PrioritizationOutputSchema>> {
  const prioritizer = new BacklogPrioritizer();
  return prioritizer.prioritize({
    backlogItems: args.backlogItems,
    sprintCapacity: args.sprintCapacity,
    businessGoals: args.businessGoals,
    riskTolerance: args.riskTolerance
  });
}

export async function executeAssessSprintRisk(
  args: z.infer<typeof SprintRiskInputSchema>
): Promise<z.infer<typeof SprintRiskOutputSchema>> {
  const assessor = new SprintRiskAssessor();
  return assessor.assessRisks({
    sprintItems: args.sprintItems,
    sprintCapacity: args.capacity,
    dependencies: args.dependencies
  });
}

export async function executeSuggestSprintComposition(
  args: z.infer<typeof SprintSuggestionInputSchema>
): Promise<z.infer<typeof SprintSuggestionOutputSchema>> {
  const service = new SprintSuggestionService();
  return service.suggestSprintComposition({
    backlogItems: args.backlogItems,
    velocity: args.velocity,
    sprintDurationDays: args.sprintDurationDays,
    teamMembers: args.teamMembers,
    businessGoals: args.businessGoals,
    riskTolerance: args.riskTolerance
  });
}

// ============================================================================
// Export all tools for registration
// ============================================================================

export const sprintAITools = [
  calculateSprintCapacityTool,
  prioritizeBacklogTool,
  assessSprintRiskTool,
  suggestSprintCompositionTool
];

export const sprintAIExecutors = {
  calculate_sprint_capacity: executeCalculateSprintCapacity,
  prioritize_backlog: executePrioritizeBacklog,
  assess_sprint_risk: executeAssessSprintRisk,
  suggest_sprint_composition: executeSuggestSprintComposition
};
```

Ensure all tools have proper annotations, input/output schemas, and executors.
  </action>
  <verify>npx tsc --noEmit src/infrastructure/tools/sprint-ai-tools.ts && grep -c "ToolDefinition" src/infrastructure/tools/sprint-ai-tools.ts</verify>
  <done>Sprint AI tools created with 4 tool definitions and executors</done>
</task>

<task type="auto">
  <name>Task 2: Create roadmap AI MCP tools and register all tools</name>
  <files>src/infrastructure/tools/roadmap-ai-tools.ts, src/infrastructure/tools/ToolRegistry.ts</files>
  <action>
**Create roadmap AI tools at `src/infrastructure/tools/roadmap-ai-tools.ts`:**

```typescript
import { z } from 'zod';
import { ANNOTATION_PATTERNS } from './annotations/tool-annotations';
import { ToolDefinition } from './ToolValidator';
import { RoadmapAIService } from '../../services/ai/RoadmapAIService';
import {
  RoadmapGenerationInputSchema,
  RoadmapOutputSchema,
  RoadmapVisualizationOutputSchema
} from './schemas/sprint-roadmap-schemas';

// ============================================================================
// Tool Definitions
// ============================================================================

/**
 * generate_roadmap - AI-13, AI-14, AI-15: Generate roadmap from requirements
 */
export const generateRoadmapTool: ToolDefinition = {
  name: 'generate_roadmap',
  title: 'Generate Roadmap',
  description: 'Generate a project roadmap from requirements. Creates phases, milestones, and dependencies with velocity-grounded date estimates.',
  annotations: ANNOTATION_PATTERNS.aiOperation, // AI non-deterministic
  inputSchema: RoadmapGenerationInputSchema,
  outputSchema: RoadmapOutputSchema
};

/**
 * generate_roadmap_visualization - AI-16: Generate visualization data
 */
export const generateRoadmapVisualizationTool: ToolDefinition = {
  name: 'generate_roadmap_visualization',
  title: 'Generate Roadmap Visualization',
  description: 'Generate visualization data for a roadmap. Returns Gantt-ready data with phases, milestones, and dependency edges.',
  annotations: ANNOTATION_PATTERNS.readOnly, // Deterministic transformation
  inputSchema: RoadmapOutputSchema, // Takes a generated roadmap
  outputSchema: RoadmapVisualizationOutputSchema
};

// ============================================================================
// Tool Executors
// ============================================================================

export async function executeGenerateRoadmap(
  args: z.infer<typeof RoadmapGenerationInputSchema>
): Promise<z.infer<typeof RoadmapOutputSchema>> {
  const service = new RoadmapAIService();
  return service.generateRoadmap({
    requirements: args.requirements,
    constraints: args.constraints,
    businessContext: args.businessContext
  });
}

export async function executeGenerateRoadmapVisualization(
  args: z.infer<typeof RoadmapOutputSchema>
): Promise<z.infer<typeof RoadmapVisualizationOutputSchema>> {
  const service = new RoadmapAIService();
  return service.generateVisualizationData(args);
}

// ============================================================================
// Export all tools for registration
// ============================================================================

export const roadmapAITools = [
  generateRoadmapTool,
  generateRoadmapVisualizationTool
];

export const roadmapAIExecutors = {
  generate_roadmap: executeGenerateRoadmap,
  generate_roadmap_visualization: executeGenerateRoadmapVisualization
};
```

**Update ToolRegistry.ts to register all 6 new tools:**

Add imports for sprint and roadmap AI tools:
```typescript
import { sprintAITools, sprintAIExecutors } from './sprint-ai-tools';
import { roadmapAITools, roadmapAIExecutors } from './roadmap-ai-tools';
```

In the registration section, add:
```typescript
// Sprint AI Tools (Phase 10)
for (const tool of sprintAITools) {
  this.registerTool(tool, sprintAIExecutors[tool.name]);
}

// Roadmap AI Tools (Phase 10)
for (const tool of roadmapAITools) {
  this.registerTool(tool, roadmapAIExecutors[tool.name]);
}
```

Update the tool count comment to reflect 6 new tools (total should be 109 + 6 = 115 tools).
  </action>
  <verify>npx tsc --noEmit src/infrastructure/tools/roadmap-ai-tools.ts && grep -c "registerTool" src/infrastructure/tools/ToolRegistry.ts</verify>
  <done>Roadmap AI tools created and all 6 tools registered in ToolRegistry</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for all AI services</name>
  <files>tests/ai-services/SprintCapacityAnalyzer.test.ts, tests/ai-services/BacklogPrioritizer.test.ts, tests/ai-services/SprintRiskAssessor.test.ts, tests/ai-services/RoadmapAIService.test.ts</files>
  <action>
Create comprehensive unit tests for all Phase 10 AI services. Follow existing test patterns from Phase 9 (see tests/ai-services/ConfidenceScorer.test.ts).

**tests/ai-services/SprintCapacityAnalyzer.test.ts (~40 tests):**

```typescript
import { SprintCapacityAnalyzer } from '../../src/services/ai/SprintCapacityAnalyzer';
import { EstimationCalibrator } from '../../src/analysis/EstimationCalibrator';

describe('SprintCapacityAnalyzer', () => {
  let analyzer: SprintCapacityAnalyzer;

  beforeEach(() => {
    jest.resetAllMocks();
    analyzer = new SprintCapacityAnalyzer();
  });

  describe('calculateCapacity', () => {
    it('should calculate capacity with given velocity', async () => {
      const result = await analyzer.calculateCapacity({
        velocity: 30,
        sprintDurationDays: 10,
        teamMembers: []
      });

      expect(result.totalPoints).toBe(30);
      expect(result.recommendedLoad).toBe(24); // 80% of 30
      expect(result.buffer.percentage).toBe(20);
    });

    it('should apply team availability factor', async () => {
      const result = await analyzer.calculateCapacity({
        velocity: 30,
        sprintDurationDays: 10,
        teamMembers: [
          { id: '1', name: 'Alice', availability: 0.5 },
          { id: '2', name: 'Bob', availability: 0.5 }
        ]
      });

      // Velocity * availability * buffer
      expect(result.totalPoints).toBe(15); // 30 * 0.5
    });

    it('should calculate velocity from history when auto', async () => {
      const result = await analyzer.calculateCapacity({
        velocity: 'auto',
        sprintDurationDays: 10,
        teamMembers: [],
        historicalSprints: [
          { completedPoints: 20 },
          { completedPoints: 25 },
          { completedPoints: 30 }
        ]
      });

      expect(result.totalPoints).toBeGreaterThan(0);
    });

    // Add more tests for edge cases, confidence scoring, etc.
  });
});
```

**tests/ai-services/BacklogPrioritizer.test.ts (~40 tests):**
- Test multi-factor scoring calculation
- Test AI scoring fallback when unavailable
- Test dependency graph integration
- Test priority tier assignment
- Test business goals influence

**tests/ai-services/SprintRiskAssessor.test.ts (~35 tests):**
- Test risk identification for overcommitment
- Test mitigation suggestions generation
- Test fallback when AI unavailable
- Test confidence scoring
- Test risk category classification

**tests/ai-services/RoadmapAIService.test.ts (~40 tests):**
- Test roadmap generation from structured requirements
- Test roadmap generation from text requirements
- Test phase sequencing logic
- Test milestone date calculation from velocity
- Test visualization data generation
- Test fallback when AI unavailable

Mock AIServiceFactory and 'ai' package following Phase 9 patterns:
```typescript
jest.mock('../../src/services/ai/AIServiceFactory', () => ({
  AIServiceFactory: {
    getInstance: jest.fn().mockReturnValue({
      getModel: jest.fn().mockReturnValue(null), // Test fallback
      getBestAvailableModel: jest.fn().mockReturnValue(null)
    })
  }
}));
```

Ensure tests cover:
1. Happy path with AI available
2. Fallback path with AI unavailable
3. Edge cases (empty inputs, boundary values)
4. Error handling
5. Confidence score calculation
  </action>
  <verify>npm test -- --testPathPattern="ai-services/(Sprint|Backlog|Roadmap)" --passWithNoTests && echo "Tests added"</verify>
  <done>Unit tests created with 150+ tests across all Phase 10 AI services</done>
</task>

<task type="auto">
  <name>Task 4: Update documentation</name>
  <files>docs/TOOLS.md, .planning/STATE.md</files>
  <action>
**Update docs/TOOLS.md with new sprint and roadmap AI tools:**

Add a new section "Sprint and Roadmap AI Tools" after the existing AI tools section:

```markdown
## Sprint and Roadmap AI Tools

AI-powered sprint planning and roadmap generation tools.

### calculate_sprint_capacity

Calculate sprint capacity based on team velocity and availability.

**Input:**
- `velocity` (number | 'auto'): Team velocity in story points, or 'auto' to calculate from history
- `sprintDurationDays` (number): Sprint duration in days
- `teamMembers` (array, optional): Team members with availability
- `historicalSprints` (array, optional): Historical sprint data for velocity calculation

**Output:**
- `totalPoints`: Calculated capacity
- `recommendedLoad`: 80% of capacity (sustainable pace)
- `buffer`: Buffer percentage and reasoning
- `confidence`: Confidence score and tier

### prioritize_backlog

AI-powered multi-factor backlog prioritization.

**Input:**
- `backlogItems` (array): Backlog items with id, title, points, priority
- `sprintCapacity` (number): Available capacity
- `businessGoals` (array, optional): Business goals to prioritize toward
- `riskTolerance` (string, optional): 'low', 'medium', 'high'

**Output:**
- `prioritizedItems`: Items with priority tier and scores
- `reasoning`: Methodology and weightings used
- `confidence`: Confidence score and tier

### assess_sprint_risk

Analyze sprint plan for potential risks.

**Input:**
- `sprintItems` (array): Items planned for sprint
- `capacity` (object): Sprint capacity
- `dependencies` (array, optional): Known dependencies

**Output:**
- `overallRisk`: 'high', 'medium', 'low'
- `riskScore`: 0-100 risk score
- `risks`: Identified risks with category, probability, impact
- `mitigations`: Suggested mitigation strategies

### suggest_sprint_composition

AI-powered sprint composition suggestion.

**Input:**
- `backlogItems` (array): Available backlog items
- `velocity` (number): Team velocity
- `sprintDurationDays` (number): Sprint duration
- `businessGoals` (array, optional): Business priorities
- `riskTolerance` (string, optional): Risk tolerance level

**Output:**
- `suggestedItems`: Items to include with reasoning
- `totalPoints`: Sum of selected items
- `capacityUtilization`: Fraction of capacity used
- `risks`: Identified risks in suggestion

### generate_roadmap

Generate project roadmap from requirements.

**Input:**
- `requirements` (string | array): Requirements as text or structured list
- `constraints` (object, optional): Timeline, team size, velocity constraints
- `businessContext` (string, optional): Additional business context

**Output:**
- `phases`: Project phases with objectives and duration
- `milestones`: Milestones with deliverables and target dates
- `dependencies`: Milestone dependencies
- `timeline`: Start/end dates and total weeks
- `confidence`: Confidence score and tier

### generate_roadmap_visualization

Generate Gantt-ready visualization data for a roadmap.

**Input:**
- Full roadmap object (from generate_roadmap)

**Output:**
- `phases`: Phase bars with start/end weeks and colors
- `milestones`: Milestone markers with week positions
- `dependencies`: Dependency edges for rendering
- `totalWeeks`: Total timeline duration
```

**Update .planning/STATE.md:**

Update current position:
```markdown
**Phase:** 10 of 12 (AI Sprint and Roadmap Planning)
**Plan:** 4 of 4 complete
**Status:** Phase complete
```

Add Phase 10 completion summary:
```markdown
## Phase 10 Completion Summary

**Phase 10: AI Sprint and Roadmap Planning** - Complete

| Plan | Name | Status | Key Results |
|------|------|--------|-------------|
| 10-01 | Domain Types and Schemas | Complete | Sprint + roadmap types, 15+ Zod schemas |
| 10-02 | Sprint AI Services | Complete | 4 services (capacity, prioritization, risk, suggestion) |
| 10-03 | Roadmap AI Service | Complete | Roadmap generation with velocity-based dates |
| 10-04 | MCP Tools and Testing | Complete | 6 MCP tools, 150+ tests |

**Requirements Verified:**
- AI-09: Sprint capacity planning (PASS)
- AI-10: Backlog prioritization (PASS)
- AI-11: Sprint risk assessment (PASS)
- AI-12: Sprint scope recommendations (PASS)
- AI-13: Roadmap generation (PASS)
- AI-14: Phase sequencing (PASS)
- AI-15: Milestone date estimation (PASS)
- AI-16: Visualization data (PASS)
```

Update metrics and Open Todos sections.
  </action>
  <verify>grep -c "calculate_sprint_capacity\|generate_roadmap" docs/TOOLS.md && grep "Phase 10" .planning/STATE.md</verify>
  <done>Documentation updated with all 6 new tools and Phase 10 completion summary</done>
</task>

</tasks>

<verification>
1. All MCP tools compile and export properly
2. Tools are registered in ToolRegistry (115 total tools)
3. Unit tests pass with 150+ tests
4. Documentation includes all 6 new tools
5. STATE.md reflects Phase 10 completion
</verification>

<success_criteria>
1. 6 MCP tools created (4 sprint, 2 roadmap)
2. All tools have proper annotations (aiOperation or readOnly)
3. All tools registered in ToolRegistry
4. 150+ unit tests with 80%+ coverage
5. docs/TOOLS.md updated with all new tools
6. STATE.md updated with Phase 10 completion
7. All 8 AI requirements (AI-09 to AI-16) verified
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-sprint-roadmap-planning/10-04-SUMMARY.md`
</output>
